<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Figtree:wght@300;400;500;600;700&display=swap');

        :root {
            --glass-bg: rgba(255, 255, 255, 0.12);
            --glass-bg-hover: rgba(255, 255, 255, 0.22);
            --glass-border: rgba(255, 255, 255, 0.35);
            --glass-border-inner: rgba(255, 255, 255, 0.6);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.18), 0 2px 8px rgba(0,0,0,0.08);
            --glass-shadow-hover: 0 20px 60px rgba(0, 0, 0, 0.25), 0 4px 16px rgba(0,0,0,0.1);
            --accent-blue: #0A84FF;
            --accent-green: #30D158;
            --accent-gray: rgba(200,200,210,0.7);
            --text-primary: rgba(255,255,255,0.95);
            --text-secondary: rgba(255,255,255,0.6);
            --text-tertiary: rgba(255,255,255,0.4);
            --blur: blur(40px) saturate(180%);
            --blur-heavy: blur(60px) saturate(200%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Figtree', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            background: #0a0a1a;
            color: var(--text-primary);
        }

        /* === LIQUID BACKGROUND === */
        .liquid-bg {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
        }

        .liquid-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse 80% 60% at 20% 10%, rgba(99,102,241,0.55) 0%, transparent 60%),
                        radial-gradient(ellipse 70% 70% at 80% 20%, rgba(14,165,233,0.45) 0%, transparent 60%),
                        radial-gradient(ellipse 60% 80% at 50% 90%, rgba(168,85,247,0.4) 0%, transparent 60%),
                        radial-gradient(ellipse 90% 50% at 10% 80%, rgba(20,184,166,0.35) 0%, transparent 60%);
        }

        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: drift 20s ease-in-out infinite;
        }

        .blob-1 {
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(99,102,241,0.8), rgba(99,102,241,0));
            top: -100px; left: -100px;
            animation-duration: 25s;
        }
        .blob-2 {
            width: 400px; height: 400px;
            background: radial-gradient(circle, rgba(14,165,233,0.7), rgba(14,165,233,0));
            top: 30%; right: -80px;
            animation-duration: 18s;
            animation-delay: -8s;
        }
        .blob-3 {
            width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(168,85,247,0.5), rgba(168,85,247,0));
            bottom: -150px; left: 30%;
            animation-duration: 22s;
            animation-delay: -14s;
        }

        @keyframes drift {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(40px, -30px) scale(1.05); }
            50% { transform: translate(-20px, 50px) scale(0.95); }
            75% { transform: translate(-50px, -20px) scale(1.02); }
        }

        /* === NOISE TEXTURE OVERLAY === */
        .noise-overlay {
            position: fixed;
            inset: 0;
            z-index: 1;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            pointer-events: none;
        }

        /* === LAYOUT === */
        .container {
            position: relative;
            z-index: 2;
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        /* === LIQUID GLASS MIXIN === */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }

        .glass::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(135deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0) 50%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }

        /* Top specular highlight */
        .glass::after {
            content: '';
            position: absolute;
            top: 0; left: 10%; right: 10%;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-border-inner), transparent);
            pointer-events: none;
        }

        /* === HEADER === */
        .header {
            margin-bottom: 36px;
            opacity: 0;
            transform: translateY(-24px);
            animation: fadeSlideDown 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .header-inner {
            display: flex;
            align-items: flex-start;
            gap: 20px;
        }

        .header-icon {
            width: 56px; height: 56px;
            background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.08));
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.35);
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            font-size: 26px;
            flex-shrink: 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.4);
        }

        .header h1 {
            font-size: 34px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-primary);
            line-height: 1.1;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 400;
            margin-top: 5px;
        }

        /* === BUS GRID === */
        .bus-list-view {
            opacity: 0;
            transform: translateY(32px);
            animation: fadeSlideUp 0.8s cubic-bezier(0.34, 1.2, 0.64, 1) 0.2s forwards;
        }

        .bus-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 14px;
        }

        /* === BUS CARD (Liquid Glass) === */
        .bus-card {
            background: rgba(255,255,255,0.10);
            backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.22);
            border-radius: 20px;
            padding: 22px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.3);
        }

        /* Specular top edge */
        .bus-card::before {
            content: '';
            position: absolute;
            top: 0; left: 15%; right: 15%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.7), transparent);
            transition: opacity 0.3s;
        }

        /* Gradient shimmer on hover */
        .bus-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.12) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.35s;
            border-radius: inherit;
            pointer-events: none;
        }

        .bus-card:hover {
            transform: translateY(-4px) scale(1.01);
            background: rgba(255,255,255,0.18);
            border-color: rgba(255,255,255,0.4);
            box-shadow: 0 16px 48px rgba(0,0,0,0.28), 0 4px 16px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.4);
        }

        .bus-card:hover::after { opacity: 1; }

        .bus-card:active {
            transform: translateY(-1px) scale(0.98);
            transition-duration: 0.1s;
        }

        .bus-number {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.3px;
            margin-bottom: 12px;
            color: var(--text-primary);
            position: relative;
            z-index: 2;
        }

        .bus-status {
            margin-bottom: 12px;
            position: relative;
            z-index: 2;
        }

        /* Liquid badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 0.2px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .status-badge::before {
            content: '';
            width: 6px; height: 6px;
            border-radius: 50%;
        }

        .status-online {
            background: rgba(48, 209, 88, 0.18);
            border: 1px solid rgba(48, 209, 88, 0.4);
            color: #30D158;
        }

        .status-online::before {
            background: #30D158;
            box-shadow: 0 0 8px #30D158;
            animation: pulse-green 2s ease-in-out infinite;
        }

        .status-offline {
            background: rgba(180, 180, 200, 0.12);
            border: 1px solid rgba(180, 180, 200, 0.25);
            color: rgba(255,255,255,0.5);
        }

        .status-offline::before {
            background: rgba(180,180,200,0.5);
        }

        @keyframes pulse-green {
            0%, 100% { opacity: 1; box-shadow: 0 0 8px #30D158; }
            50% { opacity: 0.5; box-shadow: 0 0 3px #30D158; }
        }

        .bus-info {
            color: var(--text-secondary);
            font-size: 13.5px;
            line-height: 1.5;
            position: relative;
            z-index: 2;
        }

        .line-pill-inline {
            display: inline-block;
            padding: 1px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            vertical-align: middle;
        }

        /* === DETAILS VIEW === */
        .bus-details-view {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.45s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow: hidden;
        }

        /* Frosted overlay BG */
        .bus-details-view::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(8, 8, 20, 0.6);
            backdrop-filter: blur(80px) saturate(150%);
            -webkit-backdrop-filter: blur(80px) saturate(150%);
        }

        .bus-details-view.active {
            transform: translateX(0);
            opacity: 1;
        }

        /* === DETAILS HEADER === */
        .details-header {
            position: relative;
            z-index: 2;
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(40px) saturate(200%);
            -webkit-backdrop-filter: blur(40px) saturate(200%);
            border-bottom: 1px solid rgba(255,255,255,0.12);
            padding: 20px 28px;
            display: flex;
            align-items: center;
            gap: 18px;
        }

        .details-header::after {
            content: '';
            position: absolute;
            bottom: 0; left: 10%; right: 10%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        }

        .back-button {
            background: rgba(255,255,255,0.10);
            border: 1px solid rgba(255,255,255,0.22);
            width: 36px; height: 36px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
            flex-shrink: 0;
        }

        .back-button:hover {
            background: rgba(255,255,255,0.18);
            border-color: rgba(255,255,255,0.4);
            transform: scale(1.05);
        }

        .details-title { flex: 1; }

        .details-bus-number {
            font-size: 30px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-primary);
        }

        .details-status {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 3px;
        }

        /* === DETAILS CONTENT === */
        .details-content {
            position: relative;
            z-index: 2;
            padding: 28px;
            height: calc(100vh - 82px);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.2) transparent;
        }

        /* === MONTH SELECTOR === */
        .month-selector {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 16px;
            padding: 14px 20px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.25);
        }

        .month-nav-button {
            background: rgba(255,255,255,0.10);
            border: 1px solid rgba(255,255,255,0.20);
            width: 34px; height: 34px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .month-nav-button:hover:not(:disabled) {
            background: rgba(255,255,255,0.2);
            transform: scale(1.08);
        }

        .month-nav-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .current-month {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
            letter-spacing: -0.2px;
            text-transform: capitalize;
        }

        /* === ACTIVITY ITEMS === */
        .activities-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .activity-item {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255,255,255,0.14);
            border-radius: 16px;
            padding: 16px 18px;
            position: relative;
            overflow: hidden;
            opacity: 0;
            transform: translateY(16px);
            animation: fadeSlideUp 0.45s cubic-bezier(0.34, 1.2, 0.64, 1) forwards;
            box-shadow: 0 2px 12px rgba(0,0,0,0.10), inset 0 1px 0 rgba(255,255,255,0.15);
        }

        /* Left accent bar (liquid colored) */
        .activity-item::before {
            content: '';
            position: absolute;
            left: 0; top: 12%; bottom: 12%;
            width: 3px;
            border-radius: 0 3px 3px 0;
            background: var(--activity-color, #0A84FF);
            box-shadow: 0 0 12px var(--activity-color, #0A84FF);
            opacity: 0.85;
        }

        /* Shimmer */
        .activity-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.06) 0%, transparent 60%);
            pointer-events: none;
        }

        .activity-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .line-badge {
            padding: 4px 11px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.3px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .activity-date {
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
        }

        .activity-time {
            color: var(--text-tertiary);
            font-size: 12.5px;
            margin-top: 3px;
            font-weight: 400;
        }

        .duration-pill {
            display: inline-block;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.14);
            border-radius: 8px;
            padding: 1px 7px;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-left: 6px;
        }

        /* === LOADING === */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 50px;
            color: var(--text-secondary);
            gap: 14px;
            font-size: 14px;
        }

        .loading-spinner {
            width: 22px; height: 22px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top: 2px solid rgba(255,255,255,0.7);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            flex-shrink: 0;
        }

        /* === EMPTY STATE === */
        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 52px;
            margin-bottom: 18px;
            opacity: 0.7;
            display: block;
        }

        .empty-state p {
            font-size: 15px;
            line-height: 1.6;
        }

        .empty-state p + p {
            margin-top: 10px;
            font-size: 13px;
            opacity: 0.65;
        }

        /* === TRANSITION ELEMENT === */
        .bus-number-transition {
            position: fixed;
            z-index: 1001;
            font-size: 22px;
            font-weight: 700;
            pointer-events: none;
            color: var(--text-primary);
            letter-spacing: -0.3px;
            transition: all 0.42s cubic-bezier(.84,-0.01,.15,1);
        }

        /* === ANIMATIONS === */
        @keyframes fadeSlideDown {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeSlideUp {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* === SCROLLBAR === */
        .details-content::-webkit-scrollbar { width: 4px; }
        .details-content::-webkit-scrollbar-track { background: transparent; }
        .details-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .container { padding: 18px 16px; }
            .bus-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 28px; }
            .details-header { padding: 16px 20px; }
            .details-content { padding: 18px 16px; }
            .details-bus-number { font-size: 26px; }
        }
    </style>
</head>
<body>

    <div class="liquid-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>
    <div class="noise-overlay"></div>

    <div class="container">

        <div class="bus-list-view" id="busListView">
            <div class="bus-grid" id="busGrid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Chargement des v√©hicules‚Ä¶
                </div>
            </div>
        </div>
    </div>

    <div class="bus-details-view" id="busDetailsView">
        <div class="details-header">
            <button class="back-button" id="backButton">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                </svg>
            </button>
            <div class="details-title">
                <div class="details-bus-number" id="detailsBusNumber">Bus</div>
                <div class="details-status" id="detailsStatus">V√©hicule en service</div>
            </div>
        </div>

        <div class="details-content">
            <div class="month-selector">
                <button class="month-nav-button" id="prevMonth">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                    </svg>
                </button>
                <div class="current-month" id="currentMonth">‚Äî ‚Äî</div>
                <button class="month-nav-button" id="nextMonth">
                    <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>

            <div class="activities-list" id="activitiesList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Chargement des activit√©s‚Ä¶
                </div>
            </div>
        </div>
    </div>

    <script>
        class FluentBusTracker {
            constructor() {
                this.API_BASE_URL = "https://bus-tracker.fr/api";
                this.buses = [];
                this.currentBus = null;
                this.currentMonth = this.getCurrentMonth();
                this.months = this.generateMonths();
                this.currentMonthIndex = 0;

                this.busCache = new Map();
                this.lineCache = new Map();
                this.activityCache = new Map();
                this.CACHE_DURATION = 5 * 60 * 1000;

                this.initializeElements();
                this.attachEventListeners();
                this.init();
            }

            initializeElements() {
                this.busGrid = document.getElementById('busGrid');
                this.busListView = document.getElementById('busListView');
                this.busDetailsView = document.getElementById('busDetailsView');
                this.backButton = document.getElementById('backButton');
                this.detailsBusNumber = document.getElementById('detailsBusNumber');
                this.detailsStatus = document.getElementById('detailsStatus');
                this.currentMonthDisplay = document.getElementById('currentMonth');
                this.prevMonthBtn = document.getElementById('prevMonth');
                this.nextMonthBtn = document.getElementById('nextMonth');
                this.activitiesList = document.getElementById('activitiesList');
            }

            attachEventListeners() {
                this.backButton.addEventListener('click', () => this.showBusList());
                this.prevMonthBtn.addEventListener('click', () => this.navigateMonth(1));
                this.nextMonthBtn.addEventListener('click', () => this.navigateMonth(-1));
            }

            getCurrentMonth() {
                const now = new Date();
                return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }

            generateMonths() {
                const months = [];
                const now = new Date();
                for (let i = 0; i < 12; i++) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    months.push({
                        value: `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`,
                        label: date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })
                    });
                }
                return months;
            }

            async init() {
                try {
                    this.controlParentSpinner(true);
                    await this.loadBuses();
                } catch (error) {
                    console.error('Erreur d\'initialisation', error);
                } finally {
                    this.controlParentSpinner(false);
                }
            }

            controlParentSpinner(show) {
                try {
                    window.parent.postMessage({ action: show ? 'showSpinner' : 'hideSpinner' }, '*');
                } catch (e) {}
            }

            async loadBuses() {
                const cacheKey = `allBuses-${this.currentMonth}`;
                const cached = this.getCachedData(this.busCache, cacheKey);
                if (cached) { this.buses = cached; this.renderBusList(); return; }

                try {
                    const response = await fetch('setvar/settings/BusTrackerAPI/networkId.txt');
                    const networkId = (await response.text()).trim();

                    const busData = await this.safeFetch(`${this.API_BASE_URL}/vehicles?networkId=${networkId.replace(" ", "")}&_=${Date.now()}`);
                    const uniqueLineIds = [...new Set(busData.filter(b => b.lineId).map(b => b.lineId))];
                    await this.loadLineDetails(uniqueLineIds);

                    this.buses = busData.map(bus => ({
                        ...bus,
                        lastKnownLine: bus.lineId ? this.getCachedData(this.lineCache, bus.lineId) : this.getUnknownLineDetails()
                    }));

                    this.setCachedData(this.busCache, cacheKey, this.buses);
                    this.renderBusList();
                    this.updateLastKnownLines();
                } catch (error) {
                    console.error('Erreur chargement bus', error);
                    this.showError('Impossible de charger les v√©hicules');
                }
            }

            async loadLineDetails(lineIds) {
                await Promise.all(lineIds.map(async (lineId) => {
                    if (this.getCachedData(this.lineCache, lineId)) return;
                    try {
                        const d = await this.safeFetch(`${this.API_BASE_URL}/lines/${lineId}?_=${Date.now()}`);
                        this.setCachedData(this.lineCache, lineId, {
                            color: d.color || "0A84FF",
                            textColor: d.textColor || "ffffff",
                            number: d.number || "?"
                        });
                    } catch {
                        this.setCachedData(this.lineCache, lineId, this.getUnknownLineDetails());
                    }
                }));
            }

            async updateLastKnownLines() {
                const batchSize = 20;
                for (let i = 0; i < this.buses.length; i += batchSize) {
                    await Promise.all(this.buses.slice(i, i + batchSize).map(async (bus) => {
                        try {
                            const line = await this.getLastKnownLine(bus.id, bus.lineId);
                            if (line && line.number !== "?") bus.lastKnownLine = line;
                        } catch {}
                    }));
                    if ((i + batchSize) % 40 === 0 || i + batchSize >= this.buses.length) this.renderBusList();
                    await new Promise(r => setTimeout(r, 300));
                }
            }

            async getLastKnownLine(busId, currentLineId = null) {
                if (currentLineId) {
                    const l = this.getCachedData(this.lineCache, currentLineId);
                    if (l) return l;
                }
                try {
                    const activities = await this.loadActivities(busId);
                    return this.findLastKnownLineFromActivities(activities);
                } catch { return null; }
            }

            findLastKnownLineFromActivities(activities) {
                if (!activities || !activities.length) return null;
                const all = activities.flatMap(d => d.activities || []);
                if (!all.length) return null;
                const last = all.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt))[0];
                return last?.lineDetails || null;
            }

            renderBusList() {
                const filtered = this.buses.filter(b => b.number).sort((a, b) => a.number - b.number);
                this.busGrid.innerHTML = '';
                if (!filtered.length) {
                    this.busGrid.innerHTML = `<div class="loading"><div class="loading-spinner"></div>Chargement des v√©hicules‚Ä¶</div>`;
                    return;
                }
                filtered.forEach((bus, i) => this.busGrid.appendChild(this.createBusCard(bus, i)));
            }

            createBusCard(bus, index) {
                const isOnline = bus.activity?.status === 'online';
                const lineNumber = bus.lastKnownLine?.number || '?';
                const lineColor = bus.lastKnownLine ? `#${bus.lastKnownLine.color}` : '#0A84FF';
                const textColor = bus.lastKnownLine ? `#${bus.lastKnownLine.textColor}` : '#ffffff';

                const card = document.createElement('div');
                card.className = 'bus-card';
                card.style.animationDelay = `${index * 0.04}s`;

                if (isOnline) {
                    card.style.borderColor = `${lineColor}55`;
                    card.style.boxShadow = `0 4px 24px rgba(0,0,0,0.15), 0 0 0 1px ${lineColor}33, inset 0 1px 0 rgba(255,255,255,0.3)`;
                }

                card.innerHTML = `
                    <div class="bus-number">Bus ${bus.number}</div>
                    <div class="bus-status">
                        <span class="status-badge ${isOnline ? 'status-online' : 'status-offline'}">
                            ${isOnline ? 'En service' : 'Hors service'}
                        </span>
                    </div>
                    <div class="bus-info">
                        ${isOnline
                            ? `Actuellement sur la ligne <span class="line-pill-inline" style="background:${lineColor};color:${textColor}">${lineNumber}</span>`
                            : `Derni√®re affectation : ligne <span class="line-pill-inline" style="background:${lineColor}33;color:${lineColor};border:1px solid ${lineColor}55">${lineNumber}</span>`
                        }
                        ${bus.designation ? `<br><span style="opacity:0.5;font-size:12px;margin-top:4px;display:block">${bus.designation}</span>` : ''}
                    </div>
                `;

                card.addEventListener('click', () => this.showBusDetails(bus, card));
                return card;
            }

            async showBusDetails(bus, sourceCard) {
                this.currentBus = bus;
                await this.performSharedElementTransition(sourceCard, bus);
                this.detailsBusNumber.textContent = `Bus ${bus.number}`;
                this.detailsStatus.textContent = bus.activity?.status === 'online' ? 'V√©hicule en service' : 'V√©hicule hors service';
                this.currentMonthIndex = 0;
                this.updateMonthDisplay();
                await this.loadAndDisplayActivities();
            }

            async performSharedElementTransition(sourceCard, bus) {
                const busNumberEl = sourceCard.querySelector('.bus-number');
                const rect = busNumberEl.getBoundingClientRect();

                this.detailsBusNumber.style.opacity = '0';
                setTimeout(() => { this.detailsBusNumber.style.opacity = '1'; }, 430);

                const el = document.createElement('div');
                el.className = 'bus-number-transition';
                el.textContent = `Bus ${bus.number}`;
                el.style.cssText = `left:${rect.left}px;top:${rect.top}px;width:${rect.width}px;height:${rect.height}px`;
                document.body.appendChild(el);

                this.busListView.style.opacity = '0';
                this.busListView.style.transform = 'translateX(-40px)';
                this.busDetailsView.classList.add('active');

                await new Promise(r => setTimeout(r, 50));
                const targetRect = this.detailsBusNumber.getBoundingClientRect();
                el.style.left = '78px';
                el.style.top = `${targetRect.top}px`;
                el.style.fontSize = '30px';

                setTimeout(() => document.body.removeChild(el), 420);
            }

            showBusList() {
                this.busDetailsView.classList.remove('active');
                setTimeout(() => {
                    this.busListView.style.opacity = '1';
                    this.busListView.style.transform = 'translateX(0)';
                }, 200);
                this.currentBus = null;
            }

            navigateMonth(dir) {
                const newIdx = this.currentMonthIndex + dir;
                if (newIdx >= 0 && newIdx < this.months.length) {
                    this.currentMonthIndex = newIdx;
                    this.updateMonthDisplay();
                    this.loadAndDisplayActivities();
                }
            }

            updateMonthDisplay() {
                const m = this.months[this.currentMonthIndex];
                this.currentMonthDisplay.textContent = m.label.charAt(0).toUpperCase() + m.label.slice(1);
                this.prevMonthBtn.disabled = this.currentMonthIndex >= this.months.length - 1;
                this.nextMonthBtn.disabled = this.currentMonthIndex <= 0;
            }

            async loadAndDisplayActivities() {
                if (!this.currentBus) return;
                this.activitiesList.innerHTML = `<div class="loading"><div class="loading-spinner"></div>Chargement des activit√©s‚Ä¶</div>`;
                try {
                    const acts = await this.loadActivities(this.currentBus.id, this.months[this.currentMonthIndex].value);
                    this.renderActivities(acts);
                } catch {
                    this.activitiesList.innerHTML = `<div class="empty-state"><span class="empty-state-icon">üòî</span><p>Erreur lors du chargement</p></div>`;
                }
            }

            async loadActivities(busId, month = null) {
                const m = month || this.months[this.currentMonthIndex].value;
                const key = `${busId}-${m}`;
                const cached = this.getCachedData(this.activityCache, key);
                if (cached) return cached;

                try {
                    const data = await this.safeFetch(`${this.API_BASE_URL}/vehicles/${busId}/activities?month=${m}&_=${Date.now()}`);
                    if (!data?.timeline) return [];

                    const lineIds = [...new Set(data.timeline.flatMap(d => (d.activities || []).filter(a => a.lineId).map(a => a.lineId)))];
                    await this.loadLineDetails(lineIds);

                    const processed = data.timeline.map(day => ({
                        date: day.date,
                        activities: (day.activities || []).map(act => ({
                            ...act,
                            lineDetails: act.lineId ? this.getCachedData(this.lineCache, act.lineId) || this.getUnknownLineDetails() : this.getUnknownLineDetails()
                        }))
                    }));

                    this.setCachedData(this.activityCache, key, processed);
                    return processed;
                } catch { return []; }
            }

            renderActivities(activities) {
                this.activitiesList.innerHTML = '';
                if (!activities?.length || !activities.some(d => d.activities?.length)) {
                    this.activitiesList.innerHTML = `
                        <div class="empty-state">
                            <span class="empty-state-icon">üò¥</span>
                            <p>Aucun service effectu√© ce mois-ci</p>
                            <p>Essayez une autre p√©riode pour retrouver son historique !</p>
                        </div>`;
                    return;
                }

                activities
                    .flatMap(day => (day.activities || []).map(a => ({ ...a, dayDate: day.date })))
                    .sort((a, b) => new Date(b.startedAt) - new Date(a.startedAt))
                    .forEach((act, i) => this.activitiesList.appendChild(this.createActivityElement(act, i)));
            }

            createActivityElement(activity, index) {
                const lineColor = activity.lineDetails ? `#${activity.lineDetails.color}` : '#0A84FF';
                const lineTextColor = activity.lineDetails ? `#${activity.lineDetails.textColor}` : '#ffffff';
                const lineNumber = activity.lineDetails?.number || '?';

                const dateStr = new Date(activity.dayDate).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
                const start = new Date(activity.startedAt);
                const end = new Date(activity.updatedAt);
                const duration = Math.round((end - start) / 60000);

                const el = document.createElement('div');
                el.className = 'activity-item';
                el.style.setProperty('--activity-color', lineColor);
                el.style.animationDelay = `${index * 0.04}s`;
                el.style.paddingLeft = '22px';

                el.innerHTML = `
                    <div class="activity-header">
                        <span class="line-badge" style="background:${lineColor};color:${lineTextColor}">Ligne ${lineNumber}</span>
                        <span class="activity-date">${dateStr}</span>
                    </div>
                    <div class="activity-time">
                        ${start.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' })}
                        &rarr;
                        ${end.toLocaleTimeString('fr-FR', { hour:'2-digit', minute:'2-digit' })}
                        <span class="duration-pill">${duration} min</span>
                    </div>
                `;
                return el;
            }

            getCachedData(cache, key) {
                const e = cache.get(key);
                return (e && Date.now() - e.timestamp < this.CACHE_DURATION) ? e.data : null;
            }

            setCachedData(cache, key, data) {
                cache.set(key, { data, timestamp: Date.now() });
            }

            getUnknownLineDetails() {
                return { number: "?", color: "0A84FF", textColor: "ffffff" };
            }

            async safeFetch(url, options = {}, timeoutMs = 10000, maxRetries = 2) {
                let retries = 0;
                while (retries <= maxRetries) {
                    const ctrl = new AbortController();
                    const tid = setTimeout(() => ctrl.abort(), timeoutMs);
                    try {
                        const res = await fetch(url, { ...options, signal: ctrl.signal, headers: { 'Cache-Control': 'no-cache', ...options.headers } });
                        clearTimeout(tid);
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return await res.json();
                    } catch (err) {
                        clearTimeout(tid);
                        if (++retries > maxRetries) throw err;
                        await new Promise(r => setTimeout(r, 1000 * Math.pow(2, retries - 1)));
                    }
                }
            }

            showError(msg) {
                this.busGrid.innerHTML = `<div class="empty-state"><span class="empty-state-icon">‚ö†Ô∏è</span><p>${msg}</p></div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => new FluentBusTracker());
    </script>
</body>
</html>
