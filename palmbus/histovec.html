<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @font-face {
            font-family: "League Spartan";
            src: url("src/fonts/leaguespartan.ttf") format("truetype");
            font-display: swap;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: League Spartan, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f3f3f3;
            color: #323130;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            position: relative;
        }

        .header {
            margin-bottom: 32px;
            opacity: 0;
            transform: translateY(-20px);
            animation: slideInDown 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 600;
            color: #323130;
            margin-bottom: 8px;
        }

        .header p {
            color: #605e5c;
            font-size: 14px;
        }

        .bus-list-view {
            opacity: 0;
            transform: translateY(40px);
            animation: slideInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.2s forwards;
        }

        .bus-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .bus-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            contain: layout style;
        }

        .bus-card:hover {
            transform: scale(0.99);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: rgba(0, 120, 212, 0.3);
        }

        .bus-card:active {
            transform: scale(0.96);
        }

        .bus-number {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            position: relative;
            z-index: 2;
        }

        .bus-status {
            display: grid;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-online {
            background: rgba(16, 124, 16, 0.1);
            color: #107c10;
        }

        .status-offline {
            background: rgba(196, 196, 196, 0.2);
            color: #605e5c;
        }

        .bus-info {
            color: #605e5c;
            font-size: 14px;
            line-height: 1.4;
        }

        .bus-details-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f3f3f3;
            z-index: 1000;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .bus-details-view.active {
            transform: translateX(0);
            opacity: 1;
        }

        .details-header {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(30px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-button {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .back-button:hover {
            background: rgba(0, 0, 0, 0.06);
        }

        .details-title {
            flex: 1;
        }

        .details-bus-number {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .details-status {
            color: #605e5c;
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.3s forwards;
        }

        .details-content {
            padding: 24px;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .month-selector {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .month-nav-button {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .month-nav-button:hover {
            background: rgba(0, 0, 0, 0.06);
        }

        .month-nav-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .current-month {
            font-weight: 500;
            color: #323130;
        }

        .activities-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.18);
            border-radius: 8px;
            padding: 16px;
            border-left: 4px solid #0078d4;
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            contain: layout style;
        }

        .activity-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .line-badge {
            background: #0078d4;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .activity-date {
            color: #605e5c;
            font-size: 14px;
        }

        .activity-time {
            color: #605e5c;
            font-size: 13px;
            margin-top: 4px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #605e5c;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e1dfdd;
            border-top: 2px solid #0078d4;
            border-radius: 50%;
            margin-right: 12px;
            animation: spin 1s linear infinite;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #605e5c;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        @keyframes slideInDown {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInUp {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .bus-number-transition {
            position: fixed;
            z-index: 1001;
            font-size: 24px;
            font-weight: 600;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(.84,-0.01,.15,1);
        }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .bus-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 28px; }
            .details-header { padding: 16px; }
            .details-content { padding: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="bus-list-view" id="busListView">
            <div class="bus-grid" id="busGrid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Chargement des vÃ©hicules...
                </div>
            </div>
        </div>
    </div>

    <div class="bus-details-view" id="busDetailsView">
        <div class="details-header">
            <button class="back-button" id="backButton" aria-label="Retour">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                </svg>
            </button>
            <div class="details-title">
                <div class="details-bus-number" id="detailsBusNumber">Bus</div>
                <div class="details-status" id="detailsStatus">VÃ©hicule en service</div>
            </div>
        </div>
        
        <div class="details-content">
            <div class="month-selector">
                <button class="month-nav-button" id="prevMonth" aria-label="Mois prÃ©cÃ©dent">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                    </svg>
                </button>
                <div class="current-month" id="currentMonth">----- ----</div>
                <button class="month-nav-button" id="nextMonth" aria-label="Mois suivant">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </div>
            
            <div class="activities-list" id="activitiesList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Chargement des services...
                </div>
            </div>
        </div>
    </div>

    <script>
    (() => {
        'use strict';


        // OptimisÃ© par IA parce que flemme de me clc dessus, personne utilise bus history de toute faÃ§on
        // â”€â”€â”€ Constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const API_BASE_URL   = 'https://bus-tracker.fr/api';
        const CACHE_DURATION = 5 * 60 * 1000; // 5 min
        const BATCH_SIZE     = 20;
        const BATCH_DELAY_MS = 300;
        const TIMEOUT_MS     = 10_000;
        const MAX_RETRIES    = 2;
        const MAX_VISIBLE_ACTIVITIES = 200; // virtualisation lÃ©gÃ¨re

        // â”€â”€â”€ Shared unknown line singleton â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const UNKNOWN_LINE = Object.freeze({ number: 'Inconnue', color: '0078d4', textColor: 'ffffff' });

        // â”€â”€â”€ Cache helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const busCache      = new Map();
        const lineCache     = new Map();
        const activityCache = new Map();

        function getCached(cache, key) {
            const entry = cache.get(key);
            if (entry && Date.now() - entry.ts < CACHE_DURATION) return entry.data;
            return null;
        }

        function setCache(cache, key, data) {
            cache.set(key, { data, ts: Date.now() });
            return data;
        }

        // â”€â”€â”€ Network helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function safeFetch(url, retries = MAX_RETRIES) {
            for (let attempt = 0; attempt <= retries; attempt++) {
                const controller = new AbortController();
                const tid = setTimeout(() => controller.abort(), TIMEOUT_MS);
                try {
                    const res = await fetch(url, {
                        signal: controller.signal,
                        headers: { 'Cache-Control': 'no-cache' }
                    });
                    clearTimeout(tid);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (err) {
                    clearTimeout(tid);
                    if (attempt === retries) throw err;
                    // exponential backoff
                    await sleep(1000 * (2 ** attempt));
                }
            }
        }

        function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

        // â”€â”€â”€ Line loader (deduplicated concurrent requests) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const lineInflight = new Map();

        async function loadLine(lineId) {
            if (!lineId) return UNKNOWN_LINE;
            const cached = getCached(lineCache, lineId);
            if (cached) return cached;
            if (lineInflight.has(lineId)) return lineInflight.get(lineId);

            const promise = safeFetch(`${API_BASE_URL}/lines/${lineId}?_=${Date.now()}`)
                .then(d => {
                    const details = Object.freeze({
                        color:     (d && d.color)     || '0078d4',
                        textColor: (d && d.textColor) || 'ffffff',
                        number:    (d && d.number)    || 'Inconnue'
                    });
                    setCache(lineCache, lineId, details);
                    lineInflight.delete(lineId);
                    return details;
                })
                .catch(() => {
                    lineInflight.delete(lineId);
                    return setCache(lineCache, lineId, UNKNOWN_LINE);
                });

            lineInflight.set(lineId, promise);
            return promise;
        }

        async function loadLines(ids) {
            const unique = [...new Set(ids.filter(Boolean))];
            await Promise.all(unique.map(loadLine));
        }

        // â”€â”€â”€ Notify parent frame (best-effort) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function notifyParent(action, message = '') {
            try { window.parent.postMessage({ action, message }, '*'); } catch (_) {}
        }

        // â”€â”€â”€ Month utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function buildMonths() {
            const now    = new Date();
            const result = [];
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                result.push({
                    value: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`,
                    label: d.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' })
                });
            }
            return result;
        }

        // â”€â”€â”€ DOM fragments helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function html(strings, ...vals) {
            return strings.reduce((acc, s, i) => acc + (vals[i - 1] ?? '') + s);
        }

        function escapeHtml(str) {
            return String(str ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        // â”€â”€â”€ Main class â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        class FluentBusTracker {
            constructor() {
                this.buses          = [];
                this.currentBus     = null;
                this.months         = buildMonths();
                this.currentMonthIdx= 0;
                this._loadingActivities = false;
                this._pendingMonth  = null;

                this.$busGrid        = document.getElementById('busGrid');
                this.$busListView    = document.getElementById('busListView');
                this.$busDetailsView = document.getElementById('busDetailsView');
                this.$backButton     = document.getElementById('backButton');
                this.$detailsBusNum  = document.getElementById('detailsBusNumber');
                this.$detailsStatus  = document.getElementById('detailsStatus');
                this.$currentMonth   = document.getElementById('currentMonth');
                this.$prevMonth      = document.getElementById('prevMonth');
                this.$nextMonth      = document.getElementById('nextMonth');
                this.$activitiesList = document.getElementById('activitiesList');

                this.$backButton.addEventListener('click', () => this.showBusList());
                this.$prevMonth.addEventListener('click', () => this.navigateMonth(1));
                this.$nextMonth.addEventListener('click', () => this.navigateMonth(-1));

                this.init();
            }

            async init() {
                notifyParent('showSpinner');
                try {
                    await this.loadBuses();
                } catch (err) {
                    console.warn('[BusTracker] init error:', err);
                    this.showError('Impossible de charger les vÃ©hicules. Veuillez recharger la page.');
                } finally {
                    notifyParent('hideSpinner');
                }
            }

            // â”€â”€ Load network ID + bus list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async loadBuses() {
                let networkId;
                try {
                    const res = await fetch('setvar/settings/BusTrackerAPI/networkId.txt');
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    networkId = (await res.text()).trim().replace(/\s+/g, '');
                } catch (err) {
                    throw new Error(`Impossible de lire networkId.txt : ${err.message}`);
                }

                if (!networkId) throw new Error('networkId vide');

                const cacheKey = `allBuses-${networkId}`;
                const cached   = getCached(busCache, cacheKey);
                if (cached) {
                    this.buses = cached;
                    this.renderBusList();
                    return;
                }

                const busData = await safeFetch(`${API_BASE_URL}/vehicles?networkId=${networkId}&_=${Date.now()}`);

                if (!Array.isArray(busData)) throw new Error('RÃ©ponse API inattendue (vehicles)');

                // Prefetch lines for buses currently online
                const onlineLineIds = busData
                    .filter(b => b?.activity?.status === 'online' && b.lineId)
                    .map(b => b.lineId);
                await loadLines(onlineLineIds);

                this.buses = busData
                    .filter(b => b && b.number != null)
                    .map(b => ({
                        ...b,
                        lastKnownLine: (b.lineId && getCached(lineCache, b.lineId)) || UNKNOWN_LINE
                    }));

                setCache(busCache, cacheKey, this.buses);
                this.renderBusList();

                // Background enrichment (last known lines for offline buses)
                this._enrichBusesInBackground();
            }

            // â”€â”€ Background enrichment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async _enrichBusesInBackground() {
                const offline = this.buses.filter(b => b?.activity?.status !== 'online');

                for (let i = 0; i < offline.length; i += BATCH_SIZE) {
                    const batch = offline.slice(i, i + BATCH_SIZE);
                    await Promise.all(batch.map(async bus => {
                        try {
                            const line = await this._getLastKnownLine(bus.id, bus.lineId);
                            if (line && line.number !== 'Inconnue') {
                                bus.lastKnownLine = line;
                            }
                        } catch (_) { /* silencieux */ }
                    }));

                    if (i + BATCH_SIZE < offline.length) await sleep(BATCH_DELAY_MS);

                    // Re-render only every 2 batches to avoid thrashing
                    if (i % (BATCH_SIZE * 2) === 0 || i + BATCH_SIZE >= offline.length) {
                        this.renderBusList();
                    }
                }
            }

            async _getLastKnownLine(busId, currentLineId) {
                if (currentLineId) {
                    const line = getCached(lineCache, currentLineId) || await loadLine(currentLineId);
                    if (line && line.number !== 'Inconnue') return line;
                }
                // Fallback: scan most recent month's activities
                try {
                    const acts = await this._fetchActivities(busId, this.months[0].value);
                    return this._findLastLine(acts);
                } catch (_) { return null; }
            }

            _findLastLine(timeline) {
                if (!Array.isArray(timeline) || !timeline.length) return null;
                const all = timeline.flatMap(d => Array.isArray(d.activities) ? d.activities : []);
                if (!all.length) return null;
                all.sort((a, b) => new Date(b.updatedAt ?? 0) - new Date(a.updatedAt ?? 0));
                return all[0]?.lineDetails ?? null;
            }

            // â”€â”€ Rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            renderBusList() {
                const sorted = this.buses
                    .filter(b => b?.number != null)
                    .sort((a, b) => Number(a.number) - Number(b.number));

                if (!sorted.length) {
                    this.$busGrid.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Chargement des vÃ©hicules...</div>';
                    return;
                }

                const fragment = document.createDocumentFragment();
                sorted.forEach((bus, idx) => {
                    fragment.appendChild(this._createBusCard(bus, idx));
                });
                this.$busGrid.innerHTML = '';
                this.$busGrid.appendChild(fragment);
            }

            _createBusCard(bus, index) {
                const isOnline    = bus?.activity?.status === 'online';
                const lineNumber  = bus.lastKnownLine?.number ?? 'Inconnue';
                const lineColor   = bus.lastKnownLine?.color  ? `#${bus.lastKnownLine.color}` : '#0078d4';

                const card = document.createElement('div');
                card.className = 'bus-card';
                card.style.animationDelay = `${index * 0.05}s`;
                if (isOnline) card.style.borderColor = lineColor;

                card.innerHTML = `
                    <div class="bus-number" data-bus-number="${escapeHtml(bus.number)}">Bus ${escapeHtml(bus.number)}</div>
                    <div class="bus-status">
                        <span class="status-badge ${isOnline ? 'status-online' : 'status-offline'}">
                            ${isOnline ? 'ğŸšŒ En service' : 'ğŸ˜´ Hors service'}
                        </span>
                    </div>
                    <div class="bus-info">
                        ${isOnline
                            ? `Il est actuellement sur la ligne ${escapeHtml(lineNumber)}.`
                            : `La derniÃ¨re fois qu'on l'a vu, c'Ã©tait sur la ligne ${escapeHtml(lineNumber)}.`
                        }
                        ${bus.designation ? `<br><em>${escapeHtml(bus.designation)}</em>` : ''}
                    </div>`;

                card.addEventListener('click', () => this.showBusDetails(bus, card), { passive: true });
                return card;
            }

            // â”€â”€ Detail view â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async showBusDetails(bus, sourceCard) {
                this.currentBus = bus;
                this._performTransition(sourceCard, bus);

                this.$detailsBusNum.textContent = `Bus ${bus.number}`;
                this.$detailsStatus.textContent = bus?.activity?.status === 'online'
                    ? 'VÃ©hicule en service'
                    : 'VÃ©hicule hors service';

                this.currentMonthIdx = 0;
                this._updateMonthUI();
                this._loadAndDisplayActivities();
            }

            _performTransition(sourceCard, bus) {
                const el = sourceCard.querySelector('.bus-number');
                if (!el) return;
                const rect = el.getBoundingClientRect();

                this.$detailsBusNum.style.opacity = '0';
                setTimeout(() => { this.$detailsBusNum.style.opacity = '1'; }, 430);

                const clone = document.createElement('div');
                clone.className = 'bus-number-transition';
                clone.textContent = `Bus ${bus.number}`;
                Object.assign(clone.style, {
                    left:   `${rect.left}px`,
                    top:    `${rect.top}px`,
                    width:  `${rect.width}px`,
                    height: `${rect.height}px`
                });
                document.body.appendChild(clone);

                this.$busListView.style.opacity   = '0';
                this.$busListView.style.transform = 'translateX(-50px)';
                this.$busDetailsView.classList.add('active');

                requestAnimationFrame(() => {
                    const target = this.$detailsBusNum.getBoundingClientRect();
                    Object.assign(clone.style, { left: '65px', top: `${target.top}px`, fontSize: '28px' });
                });

                setTimeout(() => { if (clone.parentNode) document.body.removeChild(clone); }, 400);
            }

            showBusList() {
                this.$busDetailsView.classList.remove('active');
                setTimeout(() => {
                    this.$busListView.style.opacity   = '1';
                    this.$busListView.style.transform = 'translateX(0)';
                }, 200);
                this.currentBus = null;
            }

            navigateMonth(dir) {
                const next = this.currentMonthIdx + dir;
                if (next < 0 || next >= this.months.length) return;
                this.currentMonthIdx = next;
                this._updateMonthUI();
                this._loadAndDisplayActivities();
            }

            _updateMonthUI() {
                const m = this.months[this.currentMonthIdx];
                this.$currentMonth.textContent = m?.label ?? '';
                this.$prevMonth.disabled = this.currentMonthIdx >= this.months.length - 1;
                this.$nextMonth.disabled = this.currentMonthIdx <= 0;
            }

            // â”€â”€ Activities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            async _loadAndDisplayActivities() {
                if (!this.currentBus) return;

                // Debounce: if already loading, queue the latest request
                if (this._loadingActivities) {
                    this._pendingMonth = this.currentMonthIdx;
                    return;
                }

                this._loadingActivities = true;
                this.$activitiesList.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Chargement des activitÃ©s...</div>';

                try {
                    const monthVal   = this.months[this.currentMonthIdx].value;
                    const activities = await this._fetchActivities(this.currentBus.id, monthVal);
                    if (!this.currentBus) return; // user may have navigated away
                    this._renderActivities(activities);
                } catch (err) {
                    console.warn('[BusTracker] activities error:', err);
                    this.$activitiesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ˜”</div>
                            <p>Erreur lors du chargement des services</p>
                        </div>`;
                } finally {
                    this._loadingActivities = false;
                    // If a newer month was requested while loading, run it now
                    if (this._pendingMonth !== null && this._pendingMonth !== this.currentMonthIdx) {
                        this.currentMonthIdx = this._pendingMonth;
                        this._pendingMonth   = null;
                        this._updateMonthUI();
                        this._loadAndDisplayActivities();
                    } else {
                        this._pendingMonth = null;
                    }
                }
            }

            async _fetchActivities(busId, month) {
                const cacheKey = `${busId}-${month}`;
                const cached   = getCached(activityCache, cacheKey);
                if (cached) return cached;

                const data = await safeFetch(`${API_BASE_URL}/vehicles/${busId}/activities?month=${month}&_=${Date.now()}`);

                if (!data?.timeline || !Array.isArray(data.timeline)) return [];

                // Collect all line IDs then batch-load
                const lineIds = data.timeline.flatMap(d =>
                    (d?.activities ?? []).map(a => a?.lineId).filter(Boolean)
                );
                await loadLines(lineIds);

                const processed = data.timeline
                    .filter(d => d?.date)
                    .map(d => ({
                        date: d.date,
                        activities: (d.activities ?? []).map(a => ({
                            ...a,
                            lineDetails: (a?.lineId && getCached(lineCache, a.lineId)) || UNKNOWN_LINE
                        }))
                    }));

                return setCache(activityCache, cacheKey, processed);
            }

            _renderActivities(timeline) {
                this.$activitiesList.innerHTML = '';

                const allActivities = (Array.isArray(timeline) ? timeline : [])
                    .flatMap(d => (d?.activities ?? []).map(a => ({ ...a, dayDate: d.date })))
                    .filter(a => a.startedAt)
                    .sort((a, b) => new Date(b.startedAt) - new Date(a.startedAt))
                    .slice(0, MAX_VISIBLE_ACTIVITIES);

                if (!allActivities.length) {
                    this.$activitiesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ˜´</div>
                            <p>Ce bus n'a effectuÃ© aucun service ce mois...</p>
                            <p style="margin-top: 8px; font-size: 14px; opacity: 0.8;">ğŸ¤” Tentez de voir une autre pÃ©riode : il se cache sÃ»rement une affectation hors du commun !</p>
                        </div>`;
                    return;
                }

                const fragment = document.createDocumentFragment();
                allActivities.forEach((act, idx) => {
                    fragment.appendChild(this._createActivityEl(act, idx));
                });
                this.$activitiesList.appendChild(fragment);
            }

            _createActivityEl(activity, index) {
                const lineColor  = activity.lineDetails?.color  ? `#${activity.lineDetails.color}` : '#0078d4';
                const lineNumber = activity.lineDetails?.number ?? 'Inconnue';

                const startedAt = activity.startedAt ? new Date(activity.startedAt) : null;
                const updatedAt = activity.updatedAt ? new Date(activity.updatedAt) : null;
                const duration  = (startedAt && updatedAt)
                    ? Math.max(0, Math.round((updatedAt - startedAt) / 60000))
                    : null;

                const dateStr = activity.dayDate
                    ? new Date(activity.dayDate).toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' })
                    : '';

                const timeStr = (startedAt && updatedAt)
                    ? `de ${startedAt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })} Ã  ${updatedAt.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}${duration !== null ? ` (${duration} min)` : ''}`
                    : '';

                const el = document.createElement('div');
                el.className = 'activity-item';
                el.style.cssText = `border-left-color:${lineColor};animation-delay:${index * 0.05}s`;

                el.innerHTML = `
                    <div class="activity-header">
                        <span class="line-badge" style="background-color:${lineColor}">Ligne ${escapeHtml(lineNumber)}</span>
                        <span class="activity-date">${escapeHtml(dateStr)}</span>
                    </div>
                    ${timeStr ? `<div class="activity-time">${escapeHtml(timeStr)}</div>` : ''}`;

                return el;
            }

            showError(msg) {
                this.$busGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <p>${escapeHtml(msg)}</p>
                    </div>`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => { new FluentBusTracker(); });
    })();
    </script>
</body>
</html>
