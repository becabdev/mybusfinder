<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBS - Powered by MyBusFinder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/protobufjs/6.11.2/protobuf.min.js"></script>
    <style>
        /* ===== VARIABLES CSS LIQUID GLASS ===== */
        :root {
            /* Couleurs principales */
            --accent-primary: #0A84FF;
            --accent-secondary: #5E5CE6;
            --accent-gradient: linear-gradient(135deg, #0A84FF 0%, #5E5CE6 100%);
            
            /* Backgrounds Liquid Glass - Light Mode */
            --glass-bg-light: rgba(255, 255, 255, 0.72);
            --glass-bg-light-hover: rgba(255, 255, 255, 0.85);
            --glass-bg-card: rgba(255, 255, 255, 0.65);
            --glass-bg-nav: rgba(255, 255, 255, 0.75);
            --glass-bg-button: rgba(255, 255, 255, 0.8);
            
            /* Backgrounds Liquid Glass - Dark Mode */
            --glass-bg-dark: rgba(28, 28, 30, 0.78);
            --glass-bg-dark-hover: rgba(28, 28, 30, 0.88);
            --glass-bg-card-dark: rgba(40, 40, 42, 0.72);
            --glass-bg-nav-dark: rgba(28, 28, 30, 0.82);
            --glass-bg-button-dark: rgba(60, 60, 62, 0.75);
            
            /* Blur */
            --glass-blur-mobile: blur(24px);
            --glass-blur-desktop: blur(40px);
            --glass-saturate: saturate(180%);
            
            /* Borders */
            --glass-border-light: rgba(0, 0, 0, 0.08);
            --glass-border-dark: rgba(255, 255, 255, 0.12);
            --glass-border-highlight: rgba(255, 255, 255, 0.3);
            
            /* Shadows */
            --glass-shadow-sm: 0 4px 16px rgba(0, 0, 0, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            --glass-shadow-md: 0 8px 32px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            --glass-shadow-lg: 0 16px 48px rgba(0, 0, 0, 0.16), inset 0 1px 0 rgba(255, 255, 255, 0.35);
            
            /* Text */
            --text-primary-light: rgba(0, 0, 0, 0.92);
            --text-secondary-light: rgba(0, 0, 0, 0.65);
            --text-primary-dark: rgba(255, 255, 255, 0.95);
            --text-secondary-dark: rgba(255, 255, 255, 0.7);
            
            /* Spacing augmenté (Liquid Glass nécessite plus d'air) */
            --spacing-xs: 8px;
            --spacing-sm: 12px;
            --spacing-md: 20px;
            --spacing-lg: 28px;
            --spacing-xl: 40px;
            
            /* Border radius */
            --radius-sm: 12px;
            --radius-md: 16px;
            --radius-lg: 20px;
            --radius-xl: 24px;
            --radius-pill: 50px;
            
            /* Transitions fluides */
            --transition-quick: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-spring: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            
            /* Background de la page */
            --page-bg-light: linear-gradient(135deg, #F0F4FF 0%, #E8EEFF 50%, #F5F0FF 100%);
            --page-bg-dark: linear-gradient(135deg, #1C1C1E 0%, #2C2C2E 100%);
        }

        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--page-bg-light);
            min-height: 100vh;
            color: var(--text-primary-light);
            overflow-x: hidden;
            position: relative;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Dark mode */
        @media (prefers-color-scheme: dark) {
            body {
                background: var(--page-bg-dark);
                color: var(--text-primary-dark);
            }
        }

        /* ===== ANIMATIONS LIQUID GLASS ===== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(24px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200% center;
            }
            100% {
                background-position: 200% center;
            }
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(10, 132, 255, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(10, 132, 255, 0);
            }
        }

        /* ===== CONTAINER ===== */
        .container {
            max-width: 680px;
            margin: 0 auto;
            padding: var(--spacing-md);
            animation: fadeInUp 0.6s ease-out;
        }

        /* ===== HEADER LIQUID GLASS ===== */
        .header {
            background: var(--glass-bg-nav);
            backdrop-filter: var(--glass-blur-mobile) var(--glass-saturate);
            -webkit-backdrop-filter: var(--glass-blur-mobile) var(--glass-saturate);
            border: 1px solid var(--glass-border-light);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md) var(--spacing-md);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--glass-shadow-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transform: translateZ(0);
            will-change: transform;
            position: sticky;
            top: var(--spacing-sm);
            z-index: 100;
            transition: all var(--transition-smooth);
        }

        @media (prefers-color-scheme: dark) {
            .header {
                background: var(--glass-bg-nav-dark);
                border-color: var(--glass-border-dark);
            }
        }

        .header.scrolled {
            background: var(--glass-bg-light-hover);
            backdrop-filter: blur(32px) var(--glass-saturate);
            -webkit-backdrop-filter: blur(32px) var(--glass-saturate);
            box-shadow: var(--glass-shadow-lg);
        }

        @media (prefers-color-scheme: dark) {
            .header.scrolled {
                background: var(--glass-bg-dark-hover);
            }
        }

        .back-btn {
            background: var(--glass-bg-button);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border-light);
            color: var(--text-primary-light);
            width: 44px;
            height: 44px;
            min-width: 44px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-smooth);
            font-size: 22px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transform: translateZ(0);
        }

        @media (prefers-color-scheme: dark) {
            .back-btn {
                background: var(--glass-bg-button-dark);
                border-color: var(--glass-border-dark);
                color: var(--text-primary-dark);
            }
        }

        .back-btn:hover {
            transform: scale(1.05) translateX(-2px);
            box-shadow: 0 4px 16px rgba(10, 132, 255, 0.2);
            background: var(--glass-bg-light-hover);
        }

        @media (prefers-color-scheme: dark) {
            .back-btn:hover {
                background: var(--glass-bg-dark-hover);
            }
        }

        .back-btn:active {
            transform: scale(0.95);
        }

        .header-content {
            flex: 1;
            min-width: 0;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .header-subtitle {
            font-size: 13px;
            color: var(--text-secondary-light);
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (prefers-color-scheme: dark) {
            .header-subtitle {
                color: var(--text-secondary-dark);
            }
        }

        /* ===== LOADING STATE ===== */
        .loading {
            text-align: center;
            padding: var(--spacing-xl);
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary-light);
            animation: shimmer 2s linear infinite;
            background: linear-gradient(90deg, 
                var(--text-secondary-light) 0%, 
                var(--text-primary-light) 50%, 
                var(--text-secondary-light) 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (prefers-color-scheme: dark) {
            .loading {
                background: linear-gradient(90deg, 
                    var(--text-secondary-dark) 0%, 
                    var(--text-primary-dark) 50%, 
                    var(--text-secondary-dark) 100%);
                background-size: 200% auto;
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
            }
        }

        /* ===== VIEWS ===== */
        .view {
            display: none;
            animation: fadeInUp 0.5s ease-out;
        }

        .view.active {
            display: block;
        }

        /* ===== SECTION TITLES ===== */
        .section-title {
            font-size: 16px;
            font-weight: 700;
            margin: var(--spacing-lg) 0 var(--spacing-md);
            padding-left: 4px;
            color: var(--text-secondary-light);
            letter-spacing: -0.01em;
            text-transform: uppercase;
            font-size: 12px;
        }

        @media (prefers-color-scheme: dark) {
            .section-title {
                color: var(--text-secondary-dark);
            }
        }

        /* ===== GLASS ITEMS (Bus, Destination, Stop) ===== */
        .bus-item, .favorite-item, .destination-item, .stop-item {
            background: var(--glass-bg-card);
            backdrop-filter: var(--glass-blur-mobile) var(--glass-saturate);
            -webkit-backdrop-filter: var(--glass-blur-mobile) var(--glass-saturate);
            border: 1px solid var(--glass-border-light);
            border-radius: var(--radius-md);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
            cursor: pointer;
            transition: all var(--transition-smooth);
            box-shadow: var(--glass-shadow-sm);
            position: relative;
            overflow: hidden;
            transform: translateZ(0);
            animation: fadeInUp 0.4s ease-out backwards;
        }

        @media (prefers-color-scheme: dark) {
            .bus-item, .favorite-item, .destination-item, .stop-item {
                background: var(--glass-bg-card-dark);
                border-color: var(--glass-border-dark);
            }
        }

        /* Animation stagger pour les listes */
        .bus-item:nth-child(1) { animation-delay: 0.05s; }
        .bus-item:nth-child(2) { animation-delay: 0.1s; }
        .bus-item:nth-child(3) { animation-delay: 0.15s; }
        .bus-item:nth-child(4) { animation-delay: 0.2s; }
        .bus-item:nth-child(5) { animation-delay: 0.25s; }
        .destination-item:nth-child(1) { animation-delay: 0.05s; }
        .destination-item:nth-child(2) { animation-delay: 0.1s; }
        .destination-item:nth-child(3) { animation-delay: 0.15s; }
        .stop-item:nth-child(1) { animation-delay: 0.05s; }
        .stop-item:nth-child(2) { animation-delay: 0.1s; }
        .stop-item:nth-child(3) { animation-delay: 0.15s; }

        /* Barre de couleur à gauche (accent subtil) */
        .bus-item::before, .destination-item::before, .stop-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 3px;
            height: 100%;
            background: var(--accent-gradient);
            transition: all var(--transition-smooth);
            opacity: 0;
        }

        .bus-item:hover, .destination-item:hover, .stop-item:hover {
            transform: scale(1.02) translateY(-2px);
            box-shadow: var(--glass-shadow-md);
            border-color: rgba(10, 132, 255, 0.3);
            background: var(--glass-bg-light-hover);
        }

        @media (prefers-color-scheme: dark) {
            .bus-item:hover, .destination-item:hover, .stop-item:hover {
                background: var(--glass-bg-dark-hover);
                border-color: rgba(10, 132, 255, 0.4);
            }
        }

        .bus-item:hover::before, .destination-item:hover::before, .stop-item:hover::before {
            opacity: 1;
            width: 4px;
        }

        .bus-item:active, .destination-item:active, .stop-item:active {
            transform: scale(0.98);
        }

        /* Effet de highlight au top */
        .bus-item::after, .destination-item::after, .stop-item::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--glass-border-highlight);
            opacity: 0.6;
        }

        /* ===== BUS ITEM ===== */
        .bus-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            font-weight: 800;
            font-size: 17px;
            margin-right: var(--spacing-sm);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            min-width: 52px;
            letter-spacing: -0.02em;
        }

        .bus-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary-light);
        }

        @media (prefers-color-scheme: dark) {
            .bus-name {
                color: var(--text-primary-dark);
            }
        }

        /* ===== FAVORITE ITEM ===== */
        .favorite-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-md);
            background: linear-gradient(135deg, 
                rgba(10, 132, 255, 0.12), 
                rgba(94, 92, 230, 0.08));
        }

        @media (prefers-color-scheme: dark) {
            .favorite-item {
                background: linear-gradient(135deg, 
                    rgba(10, 132, 255, 0.18), 
                    rgba(94, 92, 230, 0.12));
            }
        }

        .favorite-info {
            flex: 1;
            min-width: 0;
        }

        .favorite-route {
            font-weight: 700;
            font-size: 16px;
            margin-bottom: 4px;
        }

        .favorite-details {
            font-size: 13px;
            color: var(--text-secondary-light);
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (prefers-color-scheme: dark) {
            .favorite-details {
                color: var(--text-secondary-dark);
            }
        }

        .favorite-times {
            font-size: 15px;
            font-weight: 700;
            color: var(--accent-primary);
            min-width: 80px;
            text-align: right;
        }

        /* ===== TABS LIQUID GLASS ===== */
        .tabs {
            display: flex;
            gap: 6px;
            background: rgba(0, 0, 0, 0.08);
            padding: 5px;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-lg);
            position: relative;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        @media (prefers-color-scheme: dark) {
            .tabs {
                background: rgba(255, 255, 255, 0.08);
            }
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary-light);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: color var(--transition-smooth);
            font-weight: 600;
            font-size: 14px;
            position: relative;
            z-index: 1;
            letter-spacing: -0.01em;
        }

        @media (prefers-color-scheme: dark) {
            .tab {
                color: var(--text-secondary-dark);
            }
        }

        .tab.active {
            color: var(--text-primary-light);
        }

        @media (prefers-color-scheme: dark) {
            .tab.active {
                color: var(--text-primary-dark);
            }
        }

        .tab-indicator {
            position: absolute;
            top: 5px;
            left: 5px;
            height: calc(100% - 10px);
            background: var(--glass-bg-light);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border-light);
            border-radius: var(--radius-sm);
            transition: all var(--transition-smooth);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08), 
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 0;
        }

        @media (prefers-color-scheme: dark) {
            .tab-indicator {
                background: var(--glass-bg-dark);
                border-color: var(--glass-border-dark);
            }
        }

        /* ===== DATE PICKER & SELECT ===== */
        .date-picker, .destination-select {
            background: var(--glass-bg-card);
            backdrop-filter: var(--glass-blur-mobile) var(--glass-saturate);
            -webkit-backdrop-filter: var(--glass-blur-mobile) var(--glass-saturate);
            border: 1px solid var(--glass-border-light);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            color: var(--text-primary-light);
            width: 100%;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: var(--spacing-lg);
            cursor: pointer;
            transition: all var(--transition-smooth);
            box-shadow: var(--glass-shadow-sm);
        }

        @media (prefers-color-scheme: dark) {
            .date-picker, .destination-select {
                background: var(--glass-bg-card-dark);
                border-color: var(--glass-border-dark);
                color: var(--text-primary-dark);
            }
        }

        .date-picker:focus, .destination-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.15),
                        var(--glass-shadow-sm);
            transform: scale(1.01);
        }

        .date-picker:hover, .destination-select:hover {
            background: var(--glass-bg-light-hover);
            transform: scale(1.005);
        }

        @media (prefers-color-scheme: dark) {
            .date-picker:hover, .destination-select:hover {
                background: var(--glass-bg-dark-hover);
            }
        }

        .destination-select option {
            background: #FFFFFF;
            color: #000000;
        }

        @media (prefers-color-scheme: dark) {
            .destination-select option {
                background: #2C2C2E;
                color: #FFFFFF;
            }
        }

        /* ===== SCHEDULE CONTENT ===== */
        .schedule-content {
            display: none;
        }

        .schedule-content.active {
            display: block;
            animation: fadeInUp 0.4s ease-out;
        }

        .schedule-group {
            margin-bottom: var(--spacing-lg);
            animation: fadeInUp 0.5s ease-out backwards;
        }

        .schedule-group:nth-child(1) { animation-delay: 0.05s; }
        .schedule-group:nth-child(2) { animation-delay: 0.1s; }
        .schedule-group:nth-child(3) { animation-delay: 0.15s; }
        .schedule-group:nth-child(4) { animation-delay: 0.2s; }

        .schedule-hour {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: var(--spacing-sm);
            padding-left: 4px;
            color: var(--accent-primary);
            letter-spacing: -0.02em;
        }

        .schedule-times {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: var(--spacing-xs);
        }

        .schedule-time {
            background: var(--glass-bg-card);
            backdrop-filter: var(--glass-blur-mobile) var(--glass-saturate);
            -webkit-backdrop-filter: var(--glass-blur-mobile) var(--glass-saturate);
            border: 1px solid var(--glass-border-light);
            border-radius: var(--radius-sm);
            padding: 12px 8px;
            font-weight: 700;
            font-size: 15px;
            transition: all var(--transition-smooth);
            box-shadow: var(--glass-shadow-sm);
            text-align: center;
            cursor: pointer;
            transform: translateZ(0);
        }

        @media (prefers-color-scheme: dark) {
            .schedule-time {
                background: var(--glass-bg-card-dark);
                border-color: var(--glass-border-dark);
            }
        }

        .schedule-time:hover {
            background: var(--glass-bg-light-hover);
            transform: scale(1.08) translateY(-2px);
            box-shadow: var(--glass-shadow-md);
            border-color: var(--accent-primary);
        }

        @media (prefers-color-scheme: dark) {
            .schedule-time:hover {
                background: var(--glass-bg-dark-hover);
            }
        }

        .schedule-time:active {
            transform: scale(0.95);
        }

        /* ===== FLOATING ACTION BUTTON ===== */
        .favorite-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            min-width: 56px;
            min-height: 56px;
            border-radius: 50%;
            background: var(--accent-gradient);
            border: none;
            color: white;
            font-size: 26px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(10, 132, 255, 0.35),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all var(--transition-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transform: translateZ(0);
            animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .favorite-btn:hover {
            transform: scale(1.12) translateY(-2px);
            box-shadow: 0 12px 32px rgba(10, 132, 255, 0.45),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        .favorite-btn:active {
            transform: scale(0.95);
            box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3);
        }

        .favorite-btn.active {
            background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%);
            animation: pulse-glow 1.5s ease-in-out infinite;
        }

        /* ===== REALTIME ITEMS ===== */
        .realtime-item {
            background: var(--glass-bg-card);
            backdrop-filter: var(--glass-blur-mobile) var(--glass-saturate);
            -webkit-backdrop-filter: var(--glass-blur-mobile) var(--glass-saturate);
            border: 1px solid var(--glass-border-light);
            border-radius: var(--radius-md);
            padding: var(--spacing-md) var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all var(--transition-smooth);
            cursor: pointer;
            box-shadow: var(--glass-shadow-sm);
            transform: translateZ(0);
            animation: fadeInUp 0.4s ease-out backwards;
        }

        @media (prefers-color-scheme: dark) {
            .realtime-item {
                background: var(--glass-bg-card-dark);
                border-color: var(--glass-border-dark);
            }
        }

        .realtime-item:nth-child(1) { animation-delay: 0.05s; }
        .realtime-item:nth-child(2) { animation-delay: 0.1s; }
        .realtime-item:nth-child(3) { animation-delay: 0.15s; }
        .realtime-item:nth-child(4) { animation-delay: 0.2s; }

        .realtime-item:hover {
            background: var(--glass-bg-light-hover);
            transform: scale(1.02) translateY(-2px);
            box-shadow: var(--glass-shadow-md);
            border-color: rgba(10, 132, 255, 0.3);
        }

        @media (prefers-color-scheme: dark) {
            .realtime-item:hover {
                background: var(--glass-bg-dark-hover);
            }
        }

        .realtime-item:active {
            transform: scale(0.98);
        }

        .realtime-destination {
            font-weight: 700;
            font-size: 15px;
        }

        .realtime-time {
            font-size: 18px;
            font-weight: 800;
            color: var(--accent-primary);
            letter-spacing: -0.02em;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            color: var(--text-secondary-light);
        }

        @media (prefers-color-scheme: dark) {
            .empty-state {
                color: var(--text-secondary-dark);
            }
        }

        .empty-state-icon {
            font-size: 56px;
            margin-bottom: var(--spacing-md);
            opacity: 0.6;
        }

        /* ===== REALTIME PANEL (MODAL) ===== */
        #overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            z-index: 9998;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #rt-panel {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: min(600px, calc(100vw - 32px));
            max-height: calc(100vh - 120px);
            background: var(--glass-bg-light);
            backdrop-filter: var(--glass-blur-desktop) var(--glass-saturate);
            -webkit-backdrop-filter: var(--glass-blur-desktop) var(--glass-saturate);
            border: 1px solid var(--glass-border-light);
            border-radius: var(--radius-xl);
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.25),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 9999;
            overflow: hidden;
            color: var(--text-primary-light);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @media (prefers-color-scheme: dark) {
            #rt-panel {
                background: var(--glass-bg-dark);
                border-color: var(--glass-border-dark);
                color: var(--text-primary-dark);
            }
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .rt-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--glass-border-light);
            gap: var(--spacing-sm);
            background: linear-gradient(to bottom, 
                rgba(255, 255, 255, 0.1) 0%,
                rgba(255, 255, 255, 0) 100%);
        }

        @media (prefers-color-scheme: dark) {
            .rt-panel-header {
                border-bottom-color: var(--glass-border-dark);
                background: linear-gradient(to bottom, 
                    rgba(255, 255, 255, 0.05) 0%,
                    rgba(255, 255, 255, 0) 100%);
            }
        }

        #rt-panel-title {
            font-weight: 800;
            font-size: 18px;
            letter-spacing: -0.02em;
        }

        #rt-panel-close {
            cursor: pointer;
            border: none;
            background: var(--glass-bg-button);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: var(--text-primary-light);
            border: 1px solid var(--glass-border-light);
            border-radius: var(--radius-sm);
            width: 36px;
            height: 36px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-smooth);
        }

        @media (prefers-color-scheme: dark) {
            #rt-panel-close {
                background: var(--glass-bg-button-dark);
                border-color: var(--glass-border-dark);
                color: var(--text-primary-dark);
            }
        }

        #rt-panel-close:hover {
            transform: scale(1.1);
            background: var(--glass-bg-light-hover);
        }

        @media (prefers-color-scheme: dark) {
            #rt-panel-close:hover {
                background: var(--glass-bg-dark-hover);
            }
        }

        #rt-panel-close:active {
            transform: scale(0.95);
        }

        #rt-panel-content {
            padding: var(--spacing-lg);
            overflow: auto;
            max-height: calc(100vh - 220px);
        }

        .rt-stop-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--glass-border-light);
            transition: all var(--transition-smooth);
        }

        @media (prefers-color-scheme: dark) {
            .rt-stop-row {
                border-bottom-color: var(--glass-border-dark);
            }
        }

        .rt-stop-row:hover {
            background: rgba(10, 132, 255, 0.08);
        }

        .rt-stop-indicator {
            width: 10px;
            height: 10px;
            min-width: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.35);
            transition: all var(--transition-smooth);
        }

        .rt-stop-row.next .rt-stop-indicator {
            width: 12px;
            height: 12px;
            box-shadow: 0 0 0 4px rgba(10, 132, 255, 0.25);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        #rt-show-map-btn {
            cursor: pointer;
            border: none;
            color: white;
            background: var(--accent-gradient);
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: 15px;
            box-shadow: 0 4px 16px rgba(10, 132, 255, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.3);
            transition: all var(--transition-smooth);
            font-family: 'Inter', sans-serif;
        }

        #rt-show-map-btn:hover {
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 6px 20px rgba(10, 132, 255, 0.4),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }

        #rt-show-map-btn:active {
            transform: scale(0.98);
        }

        /* ===== RESPONSIVE MOBILE ===== */
        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-sm);
            }
            
            .header {
                padding: var(--spacing-sm) var(--spacing-md);
                top: var(--spacing-xs);
            }
            
            .header-title {
                font-size: 18px;
            }

            .header-subtitle {
                font-size: 12px;
            }
            
            .favorite-btn {
                width: 52px;
                height: 52px;
                min-width: 52px;
                min-height: 52px;
                bottom: 20px;
                right: 20px;
                font-size: 24px;
            }

            .bus-number {
                font-size: 16px;
                padding: 6px 12px;
                min-width: 48px;
            }

            .bus-name {
                font-size: 14px;
            }

            .schedule-times {
                grid-template-columns: repeat(auto-fill, minmax(64px, 1fr));
            }

            #rt-panel {
                width: calc(100vw - 24px);
                max-height: calc(100vh - 80px);
            }

            #rt-panel-content {
                padding: var(--spacing-md);
            }
        }

        /* ===== ACCESSIBILITY ===== */
        @media (prefers-reduced-transparency: reduce) {
            .header,
            .bus-item, .favorite-item, .destination-item, .stop-item,
            .date-picker, .destination-select,
            .schedule-time,
            .realtime-item,
            #rt-panel {
                backdrop-filter: none;
                -webkit-backdrop-filter: none;
                background: rgba(255, 255, 255, 0.95);
            }

            @media (prefers-color-scheme: dark) {
                .header,
                .bus-item, .favorite-item, .destination-item, .stop-item,
                .date-picker, .destination-select,
                .schedule-time,
                .realtime-item,
                #rt-panel {
                    background: rgba(28, 28, 30, 0.95);
                }
            }
        }

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ===== FOCUS STATES ===== */
        *:focus-visible {
            outline: 3px solid var(--accent-primary);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="back-btn" id="back-btn" style="display: none;" aria-label="Retour">←</button>
            <div class="header-content">
                <div class="header-title" id="header-title">My Bus Schedule</div>
                <div class="header-subtitle" id="header-subtitle"></div>
            </div>
        </div>

        <div id="loading" class="loading">Chargement des données...</div>

        <div id="lines-view" class="view">
            <div id="favorites-section" style="display: none;">
                <div class="section-title">⭐ FAVORIS</div>
                <div id="favorites-list"></div>
            </div>
            <div class="section-title">LIGNES DE BUS</div>
            <div id="lines-list"></div>
        </div>

        <div id="destinations-view" class="view">
            <div class="section-title">DESTINATIONS</div>
            <div id="destinations-list"></div>
        </div>

        <div id="stops-view" class="view">
            <select class="destination-select" id="destination-select" aria-label="Sélectionner une destination">
                <option value="">Choisir une destination</option>
            </select>
            <div class="section-title">ARRÊTS</div>
            <div id="stops-list"></div>
        </div>

        <div id="schedule-view" class="view">
            <div class="tabs">
                <div class="tab-indicator"></div>
                <button class="tab active" data-tab="theoretical">Horaires théoriques</button>
                <button class="tab" data-tab="realtime">Temps réel</button>
            </div>

            <input type="date" class="date-picker" id="date-picker" aria-label="Sélectionner une date">

            <div id="theoretical-content" class="schedule-content active"></div>
            <div id="realtime-content" class="schedule-content"></div>
        </div>
    </div>

    <button class="favorite-btn" id="favorite-btn" style="display: none;" aria-label="Ajouter aux favoris">★</button>

    <div id="overlay"></div>
    <div id="rt-panel">
        <div class="rt-panel-header">
            <div id="rt-panel-title">Détails</div>
            <button id="rt-panel-close" aria-label="Fermer">✕</button>
        </div>
        <div id="rt-panel-content"></div>
    </div>

    <script>
        const GTFS_ZIP_URL = 'proxy-cors/proxy_gtfs.php';
        const GTFS_RT_URL = 'proxy-cors/proxy_tripupdate.php';
        const CACHE_TTL = 24 * 60 * 60 * 1000;
        const CACHE_VERSION = '1.0';

        const state = {
            routes: {},
            stops: {},
            trips: {},
            stopTimes: {},
            calendar: {},
            calendarDates: {},
            viewHistory: [],
            currentRoute: null,
            currentStop: null,
            currentDestination: null,
            favorites: [],
            coreLoaded: false,
            realtimeInterval: null,
            loadedRoutes: new Set(),
            zipCache: null,
            zipFiles: {}
        };

        const cache = {
            serviceIds: new Map(),
            scheduleData: new Map(),
            destinations: new Map(),
            stops: new Map()
        };

        document.addEventListener('DOMContentLoaded', init);

        // Effet de scroll sur le header
        let lastScroll = 0;
        window.addEventListener('scroll', () => {
            const header = document.querySelector('.header');
            const currentScroll = window.pageYOffset;
            
            if (currentScroll > 20) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
            
            lastScroll = currentScroll;
        });

        async function init() {
            loadFavorites();
            await loadGtfsCore();
            showLines();
        }

        async function getZip() {
            if (state.zipCache) return state.zipCache;
            
            const response = await fetch(GTFS_ZIP_URL);
            if (!response.ok) {
                throw new Error(`Fichier GTFS introuvable (${response.status}). Vérifiez que ${GTFS_ZIP_URL} existe.`);
            }
            
            const arrayBuffer = await response.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            
            state.zipCache = fflate.unzipSync(uint8Array);
            
            return state.zipCache;
        }

        async function getFileFromZip(zip, filename) {
            if (!zip[filename]) return null;
            
            const decoder = new TextDecoder('utf-8');
            return decoder.decode(zip[filename]);
        }

        async function loadGtfsCore() {
            try {
                const cached = getCachedData('gtfs_core');
                if (cached) {
                    Object.assign(state, cached);
                    state.coreLoaded = true;
                    return;
                }

                const zip = await getZip();

                const requiredFiles = ['routes.txt', 'stops.txt', 'trips.txt', 'stop_times.txt'];
                const missingFiles = requiredFiles.filter(f => !zip[f]);
                
                if (missingFiles.length > 0) {
                    throw new Error(`Fichiers GTFS manquants: ${missingFiles.join(', ')}`);
                }

                if (!zip['calendar.txt'] && !zip['calendar_dates.txt']) {
                    throw new Error('Ni calendar.txt ni calendar_dates.txt trouvé. Au moins un des deux est requis.');
                }

                const [routesText, stopsText, calendarText, calendarDatesText] = await Promise.all([
                    getFileFromZip(zip, 'routes.txt'),
                    getFileFromZip(zip, 'stops.txt'),
                    getFileFromZip(zip, 'calendar.txt'),
                    getFileFromZip(zip, 'calendar_dates.txt')
                ]);

                state.routes = parseCSVToObject(routesText, 'route_id');
                state.stops = parseCSVToObject(stopsText, 'stop_id');
                
                if (calendarText) {
                    state.calendar = parseCSVToObject(calendarText, 'service_id');
                }
                
                if (calendarDatesText) {
                    const dates = parseCSV(calendarDatesText);
                    dates.forEach(cd => {
                        if (!state.calendarDates[cd.date]) {
                            state.calendarDates[cd.date] = { added: [], removed: [] };
                        }
                        if (cd.exception_type === '1') {
                            state.calendarDates[cd.date].added.push(cd.service_id);
                        } else if (cd.exception_type === '2') {
                            state.calendarDates[cd.date].removed.push(cd.service_id);
                        }
                    });
                }

                if (!calendarText && calendarDatesText) {
                    console.warn('calendar.txt manquant: utilisation de calendar_dates.txt uniquement');
                    state.calendar = {};
                }

                setCachedData('gtfs_core', {
                    routes: state.routes,
                    stops: state.stops,
                    calendar: state.calendar,
                    calendarDates: state.calendarDates
                });

                state.coreLoaded = true;
            } catch (error) {
                console.error('Erreur chargement GTFS:', error);
                document.getElementById('loading').innerHTML = `
                    <div style="text-align: center; color: #FF3B30;">
                        <div style="font-size: 56px; margin-bottom: 16px; opacity: 0.6;">⚠️</div>
                        <div style="font-weight: 700; margin-bottom: 8px; font-size: 18px;">Erreur de chargement</div>
                        <div style="font-size: 14px; opacity: 0.7;">${error.message}</div>
                    </div>
                `;
            }
        }

        async function loadTripsAndStopTimesForRoute(routeId) {
            if (state.loadedRoutes.has(routeId)) return;

            const cacheKey = `route_${routeId}`;
            const cached = getCachedData(cacheKey);
            
            if (cached) {
                state.trips[routeId] = cached.trips;
                state.stopTimes[routeId] = cached.stopTimes;
                state.loadedRoutes.add(routeId);
                return;
            }

            try {
                const zip = await getZip();

                if (!zip['trips.txt'] || !zip['stop_times.txt']) {
                    throw new Error('Fichiers trips.txt ou stop_times.txt manquants dans le ZIP');
                }

                const [tripsText, stopTimesText] = await Promise.all([
                    getFileFromZip(zip, 'trips.txt'),
                    getFileFromZip(zip, 'stop_times.txt')
                ]);

                const allTrips = parseCSV(tripsText);
                const routeTrips = allTrips.filter(t => t.route_id === routeId);
                const tripIds = new Set(routeTrips.map(t => t.trip_id));

                const allStopTimes = parseCSV(stopTimesText);
                const stopTimesByTrip = {};
                
                allStopTimes.forEach(st => {
                    if (tripIds.has(st.trip_id)) {
                        if (!stopTimesByTrip[st.trip_id]) {
                            stopTimesByTrip[st.trip_id] = [];
                        }
                        stopTimesByTrip[st.trip_id].push({
                            stop_id: st.stop_id,
                            arrival_time: formatTimeString(st.arrival_time),
                            departure_time: formatTimeString(st.departure_time || st.arrival_time),
                            stop_sequence: parseInt(st.stop_sequence, 10)
                        });
                    }
                });

                Object.values(stopTimesByTrip).forEach(times => {
                    times.sort((a, b) => a.stop_sequence - b.stop_sequence);
                });

                state.trips[routeId] = routeTrips;
                state.stopTimes[routeId] = stopTimesByTrip;
                state.loadedRoutes.add(routeId);

                setCachedData(cacheKey, {
                    trips: routeTrips,
                    stopTimes: stopTimesByTrip
                });
            } catch (error) {
                console.error('Erreur chargement route:', error);
                alert(`Erreur lors du chargement de la ligne: ${error.message}`);
            }
        }

        function parseCSV(text) {
            const lines = text.trim().split(/\r?\n/);
            const headers = parseCSVLine(lines[0]).map(h => h.trim().replace(/"/g, ''));

            return lines.slice(1).filter(l => l.trim()).map(line => {
                const values = parseCSVLine(line);
                const obj = {};
                headers.forEach((h, i) => obj[h] = (values[i] ?? '').trim().replace(/"/g, ''));
                return obj;
            });
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function parseCSVToObject(text, keyField) {
            const items = parseCSV(text);
            const obj = {};
            items.forEach(item => {
                if (item[keyField]) {
                    obj[item[keyField]] = item;
                }
            });
            return obj;
        }

        function formatTimeString(timeStr) {
            if (!timeStr) return '00h00';
            const parts = timeStr.split(':');
            let hour = parseInt(parts[0], 10);
            const minute = parts[1] || '00';
            if (hour >= 24) hour -= 24;
            return `${hour}h${minute}`;
        }

        function getCachedData(key) {
            try {
                const item = localStorage.getItem(`gtfs_${key}`);
                if (!item) return null;
                
                const data = JSON.parse(item);
                if (data.version !== CACHE_VERSION) return null;
                if (Date.now() - data.timestamp > CACHE_TTL) return null;
                
                return data.value;
            } catch {
                return null;
            }
        }

        function setCachedData(key, value) {
            try {
                if (key.startsWith('route_')) {
                    return;
                }
                
                localStorage.setItem(`gtfs_${key}`, JSON.stringify({
                    version: CACHE_VERSION,
                    timestamp: Date.now(),
                    value
                }));
            } catch (error) {
                console.warn('Cache localStorage plein, nettoyage...', error);
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('gtfs_route_')) {
                        localStorage.removeItem(key);
                    }
                });
            }
        }

        function loadFavorites() {
            const stored = localStorage.getItem('favorites');
            state.favorites = stored ? JSON.parse(stored) : [];
        }

        function saveFavorites() {
            localStorage.setItem('favorites', JSON.stringify(state.favorites));
        }

        function addToFavorites(routeId, stopId, destinationId) {
            const fav = { 
                routeId, 
                stopId, 
                destinationId,
                id: `${routeId}-${stopId}-${destinationId}`
            };
            if (!isFavorite(routeId, stopId, destinationId)) {
                state.favorites.push(fav);
                saveFavorites();
                updateFavoriteButton();
            }
        }

        function removeFromFavorites(routeId, stopId, destinationId) {
            state.favorites = state.favorites.filter(f => 
                !(f.routeId === routeId && f.stopId === stopId && f.destinationId === destinationId)
            );
            saveFavorites();
            updateFavoriteButton();
        }

        function isFavorite(routeId, stopId, destinationId) {
            return state.favorites.some(f => 
                f.routeId === routeId && f.stopId === stopId && f.destinationId === destinationId
            );
        }

        function updateFavoriteButton() {
            const btn = document.getElementById('favorite-btn');
            if (state.currentRoute && state.currentStop && state.currentDestination) {
                btn.style.display = 'flex';
                btn.classList.toggle('active', isFavorite(state.currentRoute, state.currentStop, state.currentDestination));
            } else {
                btn.style.display = 'none';
            }
        }

        async function updateFavoritesSection() {
            const section = document.getElementById('favorites-section');
            const list = document.getElementById('favorites-list');

            if (state.favorites.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            list.innerHTML = '';

            for (const fav of state.favorites) {
                await loadTripsAndStopTimesForRoute(fav.routeId);

                const route = state.routes[fav.routeId];
                const stop = state.stops[fav.stopId];
                const dest = state.stops[fav.destinationId];

                if (!route || !stop || !dest) continue;

                const item = document.createElement('div');
                item.className = 'favorite-item';
                item.innerHTML = `
                    <div class="favorite-info">
                        <div class="favorite-route">${route.route_short_name}</div>
                        <div class="favorite-details">${stop.stop_name} → ${dest.stop_name}</div>
                    </div>
                    <div class="favorite-times">Chargement...</div>
                `;
                
                item.onclick = () => showSchedule(fav.routeId, fav.stopId, fav.destinationId);
                list.appendChild(item);
            }
        }

        function hideAllViews() {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        }

        function showLines() {
            hideAllViews();
            document.getElementById('loading').style.display = 'none';
            document.getElementById('lines-view').classList.add('active');
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('header-title').textContent = 'My Bus Schedule';
            document.getElementById('header-subtitle').textContent = '';
            state.viewHistory = [];

            const linesList = document.getElementById('lines-list');
            linesList.innerHTML = '';

            Object.entries(state.routes).forEach(([routeId, route]) => {
                const item = document.createElement('div');
                item.className = 'bus-item';
                item.innerHTML = `
                    <span class="bus-number" style="background: #${route.route_color || '0A84FF'}; color: #${route.route_text_color || 'ffffff'}">
                        ${route.route_short_name}
                    </span>
                    <span class="bus-name">${route.route_long_name}</span>
                `;
                item.onclick = () => showDestinations(routeId);
                linesList.appendChild(item);
            });

            updateFavoritesSection();
        }

        async function showDestinations(routeId) {
            state.currentRoute = routeId;
            
            hideAllViews();
            document.getElementById('destinations-view').classList.add('active');
            document.getElementById('back-btn').style.display = 'block';
            
            const route = state.routes[routeId];
            document.getElementById('header-title').textContent = route.route_short_name;
            document.getElementById('header-subtitle').textContent = route.route_long_name;
            
            state.viewHistory.push('lines');

            const list = document.getElementById('destinations-list');
            list.innerHTML = '<div class="loading">Chargement des destinations...</div>';

            await loadTripsAndStopTimesForRoute(routeId);

            const destinations = getDestinations(routeId);
            list.innerHTML = '';

            destinations.forEach(dest => {
                const item = document.createElement('div');
                item.className = 'destination-item';
                item.innerHTML = `<strong>${dest.name}</strong>`;
                item.onclick = () => showStops(routeId, dest.id);
                list.appendChild(item);
            });
        }

        function showStops(routeId, destinationId = null) {
            hideAllViews();
            document.getElementById('stops-view').classList.add('active');
            document.getElementById('back-btn').style.display = 'block';
            state.viewHistory.push('destinations');

            const destinations = getDestinations(routeId);
            const select = document.getElementById('destination-select');
            select.innerHTML = '<option value="">Choisir une destination</option>';
            
            destinations.forEach(dest => {
                const option = document.createElement('option');
                option.value = dest.id;
                option.textContent = dest.name;
                if (dest.id === destinationId) option.selected = true;
                select.appendChild(option);
            });

            select.onchange = () => updateStopsForDestination(routeId, select.value);

            if (destinationId) {
                updateStopsForDestination(routeId, destinationId);
            }
        }

        function updateStopsForDestination(routeId, destinationId) {
            const list = document.getElementById('stops-list');
            list.innerHTML = '';

            if (!destinationId) return;

            const stops = getStopsForDestination(routeId, destinationId);
            
            stops.forEach(stop => {
                const item = document.createElement('div');
                item.className = 'stop-item';
                item.innerHTML = `<strong>${stop.stop_name}</strong>`;
                item.onclick = () => showSchedule(routeId, stop.stop_id, destinationId);
                list.appendChild(item);
            });
        }

        function showSchedule(routeId, stopId, destinationId) {
            state.currentRoute = routeId;
            state.currentStop = stopId;
            state.currentDestination = destinationId;

            hideAllViews();
            document.getElementById('schedule-view').classList.add('active');
            document.getElementById('back-btn').style.display = 'block';
            state.viewHistory.push('stops');

            const route = state.routes[routeId];
            const stop = state.stops[stopId];
            document.getElementById('header-title').textContent = `${route.route_short_name} - ${stop.stop_name}`;

            updateFavoriteButton();
            setupTabHandlers();
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-picker').value = today;
            
            updateScheduleByDate(routeId, stopId, destinationId, today);
        }

        function setupTabHandlers() {
            const tabs = document.querySelectorAll('.tab');
            const indicator = document.querySelector('.tab-indicator');
            const datePicker = document.getElementById('date-picker');

            tabs.forEach((tab, index) => {
                tab.onclick = () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    const width = tab.offsetWidth;
                    const left = tab.offsetLeft;
                    indicator.style.width = `${width}px`;
                    indicator.style.transform = `translateX(${left}px)`;

                    document.querySelectorAll('.schedule-content').forEach(c => c.classList.remove('active'));
                    
                    if (tab.dataset.tab === 'theoretical') {
                        document.getElementById('theoretical-content').classList.add('active');
                        datePicker.style.display = 'block';
                    } else {
                        document.getElementById('realtime-content').classList.add('active');
                        datePicker.style.display = 'none';
                        loadRealtimeData();
                    }
                };
            });

            const activeTab = document.querySelector('.tab.active');
            indicator.style.width = `${activeTab.offsetWidth}px`;
            indicator.style.transform = `translateX(${activeTab.offsetLeft}px)`;

            datePicker.onchange = (e) => {
                updateScheduleByDate(state.currentRoute, state.currentStop, state.currentDestination, e.target.value);
            };
        }
        
        function computeGtfsDateAndDow(dateString) {
            const gtfsDate = dateString.replace(/-/g, '');
            const safe = new Date(dateString + 'T12:00:00');
            const dayOfWeek = safe.getDay();
            return { gtfsDate, dayOfWeek };
        }

        function updateScheduleByDate(routeId, stopId, destinationId, dateString) {
            const { gtfsDate, dayOfWeek } = computeGtfsDateAndDow(dateString);
            const activeServiceIds = getActiveServiceIds(dayOfWeek, gtfsDate);

            if (activeServiceIds.length === 0) {
                const container = document.getElementById('theoretical-content');
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📅</div><div>Aucun service actif pour cette date</div></div>';
                return;
            }

            const validTrips = state.trips[routeId].filter(trip => 
                activeServiceIds.includes(trip.service_id)
            );

            displaySchedule(validTrips, stopId, destinationId, document.getElementById('theoretical-content'));
        }

        function displaySchedule(validTrips, stopId, destinationId, container) {
            container.innerHTML = '';

            const schedule = [];
            const stopTimesByRoute = state.stopTimes[state.currentRoute];

            validTrips.forEach(trip => {
                const tripStops = stopTimesByRoute[trip.trip_id];
                if (!tripStops || tripStops.length === 0) return;

                const stopIndex = tripStops.findIndex(st => st.stop_id === stopId);
                const destIndex = tripStops.findIndex(st => st.stop_id === destinationId);

                if (stopIndex === -1 || destIndex === -1 || stopIndex >= destIndex) return;

                schedule.push(tripStops[stopIndex].arrival_time);
            });

            if (schedule.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🚌</div><div>Aucun horaire disponible pour cette combinaison</div></div>';
                return;
            }

            const timesByHour = {};
            schedule.forEach(time => {
                const [hour, minute] = time.split('h');
                if (!timesByHour[hour]) timesByHour[hour] = [];
                timesByHour[hour].push(minute);
            });

            Object.keys(timesByHour)
                .sort((a, b) => parseInt(a, 10) - parseInt(b, 10))
                .forEach(hour => {
                    const group = document.createElement('div');
                    group.className = 'schedule-group';

                    const hourTitle = document.createElement('div');
                    hourTitle.className = 'schedule-hour';
                    hourTitle.textContent = `${hour}h`;
                    group.appendChild(hourTitle);

                    const times = document.createElement('div');
                    times.className = 'schedule-times';

                    const uniqueMinutes = [...new Set(timesByHour[hour])]
                        .sort((a, b) => parseInt(a, 10) - parseInt(b, 10));

                    uniqueMinutes.forEach(minute => {
                        const timeEl = document.createElement('div');
                        timeEl.className = 'schedule-time';
                        timeEl.textContent = minute;
                        times.appendChild(timeEl);
                    });

                    group.appendChild(times);
                    container.appendChild(group);
                });
        }

        function getActiveServiceIds(dayOfWeek, gtfsDate) {
            const cacheKey = `${dayOfWeek}_${gtfsDate}`;
            if (cache.serviceIds.has(cacheKey)) return cache.serviceIds.get(cacheKey);

            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayName = dayNames[dayOfWeek];

            let serviceIds = [];

            const hasCalendar = state.calendar && Object.keys(state.calendar).length > 0;

            if (hasCalendar) {
                for (const [serviceId, cal] of Object.entries(state.calendar)) {
                    const inRange = gtfsDate >= cal.start_date && gtfsDate <= cal.end_date;
                    if (!inRange) continue;

                    if (String(cal[dayName]).trim() === '1') {
                        serviceIds.push(serviceId);
                    }
                }
            } else {
                serviceIds = [];
            }

            const ex = state.calendarDates?.[gtfsDate];
            if (ex) {
                for (const id of ex.added || []) {
                    if (!serviceIds.includes(id)) serviceIds.push(id);
                }
                for (const id of ex.removed || []) {
                    serviceIds = serviceIds.filter(sid => sid !== id);
                }
            }

            cache.serviceIds.set(cacheKey, serviceIds);
            return serviceIds;
        }

        function getDestinations(routeId) {
            if (cache.destinations.has(routeId)) {
                return cache.destinations.get(routeId);
            }

            const trips = state.trips[routeId];
            const stopTimesByRoute = state.stopTimes[routeId];
            const destinations = new Map();

            trips.forEach(trip => {
                const tripStops = stopTimesByRoute[trip.trip_id];
                if (tripStops && tripStops.length > 0) {
                    const lastStop = tripStops[tripStops.length - 1];
                    const stop = state.stops[lastStop.stop_id];
                    if (stop && !destinations.has(stop.stop_id)) {
                        destinations.set(stop.stop_id, { 
                            id: stop.stop_id, 
                            name: stop.stop_name 
                        });
                    }
                }
            });

            const result = Array.from(destinations.values());
            cache.destinations.set(routeId, result);
            return result;
        }

        function getStopsForDestination(routeId, destinationId) {
            const cacheKey = `${routeId}_${destinationId}`;
            if (cache.stops.has(cacheKey)) {
                return cache.stops.get(cacheKey);
            }

            const trips = state.trips[routeId];
            const stopTimesByRoute = state.stopTimes[routeId];
            const stopsMap = new Map();

            trips.forEach(trip => {
                const tripStops = stopTimesByRoute[trip.trip_id];
                if (!tripStops) return;

                const destIndex = tripStops.findIndex(st => st.stop_id === destinationId);
                if (destIndex === -1) return;

                tripStops.slice(0, destIndex).forEach(st => { 
                    const stop = state.stops[st.stop_id];
                    if (stop && !stopsMap.has(stop.stop_id)) {
                        stopsMap.set(stop.stop_id, stop);
                    }
                });
            });

            const result = Array.from(stopsMap.values());
            cache.stops.set(cacheKey, result);
            return result;
        }

        async function loadRealtimeData() {
            const container = document.getElementById('realtime-content');
            container.innerHTML = '<div class="loading">Chargement des données temps réel...</div>';

            try {
                const response = await fetch(GTFS_RT_URL);
                const buffer = await response.arrayBuffer();
                
                const root = await protobuf.load('src/gtfs-realtime.proto');
                const FeedMessage = root.lookupType('transit_realtime.FeedMessage');
                const message = FeedMessage.decode(new Uint8Array(buffer));

                const arrivals = processRealtimeDataForStop(message, state.currentRoute, state.currentStop);
                displayRealtimeArrivals(arrivals, container);
            } catch (error) {
                console.error('Erreur temps réel:', error);
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">⚠️</div><div>Données temps réel non disponibles</div></div>';
            }
        }

        function pad2(n) { return String(n).padStart(2, '0'); }

        function parseTimeHHhMM(timeStr) {
            const [h, m] = timeStr.split('h').map(x => parseInt(x, 10));
            return { h: isNaN(h) ? 0 : h, m: isNaN(m) ? 0 : m };
        }

        function buildDateFromPicker(timeHHhMM, dateString) {
            const { h, m } = parseTimeHHhMM(timeHHhMM);
            const d = new Date(dateString + 'T12:00:00');
            d.setHours(h, m, 0, 0);
            return d;
        }

        function getTheoreticalTimeForTripStop(routeId, tripId, stopId, dateString) {
            const stopTimesByRoute = state.stopTimes[routeId];
            const tripStops = stopTimesByRoute?.[tripId];
            if (!tripStops) return null;

            const st = tripStops.find(x => x.stop_id === stopId);
            if (!st?.arrival_time) return null;

            return buildDateFromPicker(st.arrival_time, dateString);
        }

        function minutesDiff(a, b) {
            return Math.round((a.getTime() - b.getTime()) / 60000);
        }

        function matchesCurrentRouteRt(tripDescriptor, routeId) {
            const rtRouteId = tripDescriptor?.routeId || tripDescriptor?.route_id;
            if (rtRouteId) return String(rtRouteId) === String(routeId);

            const rtTripId = tripDescriptor?.tripId || tripDescriptor?.trip_id;
            if (!rtTripId) return false;

            const routeTrips = state.trips?.[routeId] || [];
            return routeTrips.some(t => String(t.trip_id) === String(rtTripId));
        }

        function ensureRtUi() {
            let overlay = document.getElementById('overlay');
            let panel = document.getElementById('rt-panel');
            
            const close = () => closeRtPanel();
            overlay.onclick = close;
            const closeBtn = document.getElementById('rt-panel-close');
            if (closeBtn) closeBtn.onclick = close;
        }

        function openRtPanel(title, html) {
            ensureRtUi();
            const overlay = document.getElementById('overlay');
            const panel = document.getElementById('rt-panel');
            const titleEl = document.getElementById('rt-panel-title');
            const contentEl = document.getElementById('rt-panel-content');

            if (titleEl) titleEl.textContent = title || 'Détails';
            if (contentEl) contentEl.innerHTML = html || '';

            overlay.style.display = 'block';
            panel.style.display = 'block';
        }

        function closeRtPanel() {
            const overlay = document.getElementById('overlay');
            const panel = document.getElementById('rt-panel');
            if (overlay) overlay.style.display = 'none';
            if (panel) panel.style.display = 'none';
        }

        function getMinutesFromHHhMM(timeStr) {
            const [h, m] = (timeStr || '').split('h').map(x => parseInt(x, 10));
            return (isNaN(h) ? 0 : h) * 60 + (isNaN(m) ? 0 : m);
        }

        function sendVehicleToParent(vehicleId, tripId) {
            const message = {
                type: 'vehicleSelected',
                vehicleId: vehicleId || null,
                tripId: tripId || null,
                stopId: state.currentStop || null,
                routeId: state.currentRoute || null,
                timestamp: new Date().getTime()
            };

            if (window.parent && window.parent !== window) {
                window.parent.postMessage(message, '*');
            } else if (window.opener) {
                window.opener.postMessage(message, '*');
            } else {
                console.warn('Aucun parent/opener pour recevoir le message:', message);
            }
        }

        function showStopsTimelineForTrip(routeId, tripId, vehicleId) {
            ensureRtUi();

            const route = state.routes?.[routeId];
            const routeLabel = route?.route_short_name ? `${route.route_short_name}` : 'Ligne';
            const routeColor = route?.route_color ? `#${route.route_color}` : '#0A84FF';

            const tripStops = state.stopTimes?.[routeId]?.[tripId];
            if (!tripStops || tripStops.length === 0) {
                openRtPanel(
                    `Bus ${vehicleId || '—'} • ${routeLabel}`,
                    `<div style="opacity:.8">Aucun détail d'arrêts pour ce trajet.</div>`
                );
                return;
            }

            const now = new Date();
            const nowMin = now.getHours() * 60 + now.getMinutes();

            let nextIndex = 0;
            for (let i = 0; i < tripStops.length; i++) {
                const tMin = getMinutesFromHHhMM(tripStops[i].arrival_time);
                if (tMin >= nowMin) { nextIndex = i; break; }
                nextIndex = i;
            }

            const rows = tripStops.map((st, idx) => {
                const stopName = state.stops?.[st.stop_id]?.stop_name || st.stop_id;
                const time = st.arrival_time || '--h--';

                const isNext = idx === nextIndex;
                const isPast = idx < nextIndex;

                return `
                    <div class="rt-stop-row ${isNext ? 'next' : ''}" style="opacity:${isPast ? '.55' : '1'};">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="rt-stop-indicator" style="background:${isNext ? routeColor : 'rgba(255,255,255,.35)'};"></div>
                            <div>${stopName}</div>
                        </div>
                        <div style="font-weight:800;">${time}</div>
                    </div>
                `;
            }).join('');

            const html = `
                <div style="display:flex; align-items:center; gap:10px; margin-bottom:16px; flex-wrap:wrap;">
                    <div style="width:12px; height:12px; border-radius:50%; background:${routeColor}; box-shadow:0 0 0 4px rgba(10,132,255,.25)"></div>
                    <div style="font-weight:800; font-size: 16px;">${routeLabel}</div>
                    <div style="opacity:.75; font-size: 14px;">• Trajet ${tripId}</div>
                    ${vehicleId ? `<div style="margin-left:auto; font-weight:800; font-size: 15px;">Bus ${vehicleId}</div>` : ''}
                </div>

                <div style="border:1px solid var(--glass-border-light); border-radius:${
                    getComputedStyle(document.documentElement).getPropertyValue('--radius-md')
                }; overflow:hidden; margin-bottom: 16px;">
                    ${rows}
                </div>

                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button id="rt-show-map-btn">
                        Afficher dans la carte
                    </button>
                </div>
            `;

            openRtPanel(`Détails • ${routeLabel}`, html);

            const btn = document.getElementById('rt-show-map-btn');
            if (btn) {
                btn.onclick = () => {
                    sendVehicleToParent(vehicleId, tripId);
                    closeRtPanel();
                };
            }
        }

        function processRealtimeDataForStop(message, routeId, stopId) {
            const arrivals = [];
            const now = Date.now() / 1000;

            message.entity.forEach(entity => {
                if (!entity.tripUpdate) return;

                const tu = entity.tripUpdate;
                const td = tu.trip;

                const tripId = td.tripId || td.trip_id;
                if (!tripId) return;

                const rtRouteId = td.routeId || td.route_id;
                if (rtRouteId && String(rtRouteId) !== String(routeId)) return;

                if (!rtRouteId) {
                    const routeTrips = state.trips?.[routeId] || [];
                    const ok = routeTrips.some(t => String(t.trip_id) === String(tripId));
                    if (!ok) return;
                }

                const vehicleId =
                    entity.vehicle?.id || entity.vehicle?.label || tu.vehicle?.id || tu.vehicle?.label ||
                    entity.vehicle?.vehicle?.id || entity.vehicle?.vehicle?.label;

                tu.stopTimeUpdate?.forEach(update => {
                    if (update.stopId !== stopId) return;

                    const arrivalTime = update.arrival?.time || update.departure?.time;
                    if (!arrivalTime || arrivalTime <= now) return;

                    arrivals.push({
                        time: arrivalTime,
                        tripId: tripId,
                        vehicleId: vehicleId,
                        headsign: td.tripHeadsign || td.trip_headsign || 'Destination'
                    });
                });
            });

            return arrivals.sort((a, b) => a.time - b.time).slice(0, 8);
        }

        function displayRealtimeArrivals(arrivals, container) {
            container.innerHTML = '';

            if (!arrivals || arrivals.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🚌</div><div>Aucune arrivée prévue</div></div>';
                return;
            }

            arrivals.forEach(arr => {
                const date = new Date(arr.time * 1000);
                const hh = pad2(date.getHours());
                const mm = pad2(date.getMinutes());

                const item = document.createElement('div');
                item.className = 'realtime-item';

                const busLabel = arr.vehicleId ? `Bus ${arr.vehicleId}` : '';

                item.innerHTML = `
                    <div>
                        <div class="realtime-destination" style="display:flex; gap:10px; align-items:baseline; flex-wrap:wrap;">
                            <span>${arr.headsign || 'Destination'}</span>
                            ${busLabel ? `<span style="font-size:12px; opacity:.65; font-weight: 600;">${busLabel}</span>` : ''}
                        </div>
                        ${arr.delayText ? `<div style="font-size:13px; margin-top:4px; opacity:.8;">${arr.delayText}</div>` : ''}
                    </div>
                    <div class="realtime-time">${hh}h${mm}</div>
                `;

                item.addEventListener('click', () => {
                    showStopsTimelineForTrip(state.currentRoute, arr.tripId, arr.vehicleId);
                });

                container.appendChild(item);
            });
        }

        function goBack() {
            const previous = state.viewHistory.pop();
            
            if (!previous) {
                showLines();
                return;
            }

            switch (previous) {
                case 'lines':
                    showLines();
                    break;
                case 'destinations':
                    showDestinations(state.currentRoute);
                    break;
                case 'stops':
                    showStops(state.currentRoute, state.currentDestination);
                    break;
            }
        }

        document.getElementById('back-btn').onclick = goBack;
        
        document.getElementById('favorite-btn').onclick = () => {
            if (isFavorite(state.currentRoute, state.currentStop, state.currentDestination)) {
                removeFromFavorites(state.currentRoute, state.currentStop, state.currentDestination);
            } else {
                addToFavorites(state.currentRoute, state.currentStop, state.currentDestination);
            }
            updateFavoritesSection();
        };

        window.addEventListener('beforeunload', () => {
            if (state.realtimeInterval) {
                clearInterval(state.realtimeInterval);
            }
        });
    </script>
</body>
</html>
